<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediSync AI ‚Äî Unified Healthcare Intelligence Platform v3.0</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Fraunces:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f0f4f8;
  --surface: #ffffff;
  --surface2: #f8fafc;
  --surface3: #eef2f7;
  --border: #dde3ec;
  --border2: #c8d3e0;
  --primary: #2563eb;
  --primary-l: #3b82f6;
  --primary-xl: #dbeafe;
  --secondary: #0891b2;
  --accent: #059669;
  --accent-l: #d1fae5;
  --warn: #d97706;
  --warn-l: #fef3c7;
  --danger: #dc2626;
  --danger-l: #fee2e2;
  --purple: #7c3aed;
  --purple-l: #ede9fe;
  --text: #0f172a;
  --text2: #334155;
  --text3: #64748b;
  --text4: #94a3b8;
  --card-shadow: 0 1px 3px rgba(15,23,42,.07), 0 4px 16px rgba(15,23,42,.05);
  --card-shadow-h: 0 4px 12px rgba(37,99,235,.12), 0 8px 24px rgba(15,23,42,.1);
  --radius: 14px;
  --radius-sm: 8px;
  --api: http://localhost:8000;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#login-screen{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#1e3a5f 0%,#0f172a 50%,#1a2a4a 100%);display:flex;align-items:center;justify-content:center;overflow:hidden}
#login-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 30% 40%,rgba(37,99,235,.25) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 80% 70%,rgba(8,145,178,.15) 0%,transparent 60%)}
.login-card{position:relative;z-index:1;background:rgba(255,255,255,.97);border-radius:24px;padding:48px 44px;width:100%;max-width:440px;box-shadow:0 32px 80px rgba(0,0,0,.35)}
.login-logo{display:flex;align-items:center;gap:10px;margin-bottom:32px}
.login-logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}
.login-logo-text{font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--text)}
.login-logo-text span{color:var(--primary)}
.login-title{font-size:26px;font-weight:800;margin-bottom:6px}
.login-sub{color:var(--text3);font-size:14px;margin-bottom:32px}
.login-field{margin-bottom:16px}
.login-field label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.login-field input{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;color:var(--text);background:var(--surface2);outline:none;transition:.2s}
.login-field input:focus{border-color:var(--primary);background:#fff}
.btn-login{width:100%;padding:13px;background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:.2s;margin-bottom:20px}
.btn-login:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(37,99,235,.4)}
.login-toggle{text-align:center;margin-top:16px;font-size:13px;color:var(--text3)}
.login-toggle a{color:var(--primary);font-weight:600;cursor:pointer;text-decoration:none}
#login-err{color:var(--danger);font-size:12px;margin-bottom:12px;display:none;padding:8px 12px;background:var(--danger-l);border-radius:7px}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{position:fixed;top:0;left:0;right:0;z-index:1000;height:60px;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:4px}
.nav-logo{font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--text);margin-right:auto;cursor:pointer;display:flex;align-items:center;gap:8px;text-decoration:none}
.nav-logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px}
.nav-logo span{color:var(--primary)}
nav button{background:none;border:none;color:var(--text3);font-size:12.5px;font-weight:600;cursor:pointer;padding:7px 11px;border-radius:8px;transition:all .18s;white-space:nowrap;font-family:inherit}
nav button:hover{color:var(--primary);background:var(--primary-xl)}
nav button.active{color:var(--primary);background:var(--primary-xl)}
.nav-user{display:flex;align-items:center;gap:8px;margin-left:8px;cursor:pointer;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);font-size:13px;font-weight:600;color:var(--text2)}
.nav-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700}
.nav-alert-badge{background:var(--danger);color:#fff;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:700;display:none;align-items:center;justify-content:center}
.nav-alert-badge.show{display:flex}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;min-height:100vh;padding:76px 0 60px;animation:fadeUp .3s ease}
.page.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.container{max-width:1100px;margin:0 auto;padding:0 28px}
.page-header{margin-bottom:32px}
.pill{display:inline-flex;align-items:center;gap:6px;background:var(--primary-xl);color:var(--primary);border:1px solid rgba(37,99,235,.2);border-radius:100px;padding:4px 14px;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;margin-bottom:10px}
h1{font-family:'Fraunces',serif;font-size:clamp(28px,4vw,52px);font-weight:700;line-height:1.1;letter-spacing:-.5px}
h2{font-family:'Fraunces',serif;font-size:clamp(20px,3vw,34px);font-weight:700;letter-spacing:-.3px;margin-bottom:10px}
h3{font-size:15px;font-weight:700;letter-spacing:-.2px}
.muted{color:var(--text3);line-height:1.7}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--card-shadow);transition:box-shadow .2s}
.card:hover{box-shadow:var(--card-shadow-h)}
.card-sm{padding:16px}
.card-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.card-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.ci-blue{background:var(--primary-xl)}
.ci-green{background:var(--accent-l)}
.ci-yellow{background:var(--warn-l)}
.ci-red{background:var(--danger-l)}
.ci-purple{background:var(--purple-l)}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.g2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.g3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.g4{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.g-stat{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.inp{width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-size:13.5px;outline:none;transition:.2s;font-family:inherit}
.inp:focus{border-color:var(--primary);background:#fff;box-shadow:0 0 0 3px rgba(37,99,235,.08)}
.inp::placeholder{color:var(--text4)}
select.inp option{background:#fff;color:var(--text)}
label{display:block;font-size:11.5px;color:var(--text2);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.field{margin-bottom:14px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-p{background:linear-gradient(135deg,var(--primary),var(--primary-l));border:none;color:#fff;padding:11px 24px;border-radius:10px;font-size:13.5px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;display:inline-flex;align-items:center;gap:8px}
.btn-p:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(37,99,235,.35)}
.btn-p:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.btn-s{background:var(--surface);border:1.5px solid var(--border);color:var(--text2);padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit;display:inline-flex;align-items:center;gap:7px}
.btn-s:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:linear-gradient(135deg,var(--danger),#ef4444);border:none;color:#fff;padding:9px 18px;border-radius:9px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;font-family:inherit}

/* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
.tag{display:inline-flex;align-items:center;gap:4px;border-radius:6px;padding:2px 10px;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace}
.tg-g{background:var(--accent-l);color:var(--accent);border:1px solid rgba(5,150,105,.2)}
.tg-b{background:var(--primary-xl);color:var(--primary);border:1px solid rgba(37,99,235,.2)}
.tg-y{background:var(--warn-l);color:var(--warn);border:1px solid rgba(217,119,6,.2)}
.tg-r{background:var(--danger-l);color:var(--danger);border:1px solid rgba(220,38,38,.2)}
.tg-p{background:var(--purple-l);color:var(--purple);border:1px solid rgba(124,58,237,.2)}
.tg-c{background:#e0f2fe;color:var(--secondary);border:1px solid rgba(8,145,178,.2)}

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.alert{padding:10px 14px;border-radius:9px;font-size:13px;display:none;align-items:center;gap:9px}
.alert.show{display:flex}
.al-s{background:var(--accent-l);border:1px solid rgba(5,150,105,.25);color:var(--accent)}
.al-e{background:var(--danger-l);border:1px solid rgba(220,38,38,.25);color:var(--danger)}
.al-i{background:var(--primary-xl);border:1px solid rgba(37,99,235,.2);color:var(--primary)}
.al-w{background:var(--warn-l);border:1px solid rgba(217,119,6,.2);color:var(--warn)}

/* ‚îÄ‚îÄ API STATUS ‚îÄ‚îÄ */
.api-badge{display:inline-flex;align-items:center;gap:7px;padding:5px 14px;border-radius:100px;font-size:11.5px;font-weight:600}
.api-on{background:var(--accent-l);border:1px solid rgba(5,150,105,.25);color:var(--accent)}
.api-off{background:var(--danger-l);border:1px solid rgba(220,38,38,.25);color:var(--danger)}
.dot{width:7px;height:7px;border-radius:50%}
.dot-g{background:var(--accent);animation:pulse 2s infinite}
.dot-r{background:var(--danger)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
table{width:100%;border-collapse:collapse}
th{background:var(--surface3);color:var(--text3);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;padding:10px 14px;text-align:left;border-bottom:1.5px solid var(--border)}
td{padding:11px 14px;font-size:13px;color:var(--text2);border-bottom:1px solid var(--border)}
tr:hover td{background:var(--surface2)}
tr:last-child td{border-bottom:none}

/* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(37,99,235,.2);border-top-color:var(--primary);border-radius:50%;animation:spin .65s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ STAT CARD ‚îÄ‚îÄ */
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--card-shadow)}
.stat-val{font-size:28px;font-weight:800;font-family:'Fraunces',serif;color:var(--text);line-height:1}
.stat-lbl{font-size:12px;color:var(--text3);margin-top:4px;font-weight:500}
.stat-delta{font-size:11px;font-weight:700;margin-top:8px;display:inline-flex;align-items:center;gap:3px}
.delta-up{color:var(--accent)}
.delta-dn{color:var(--danger)}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.bar-bg{background:var(--surface3);border-radius:100px;height:10px;overflow:hidden}
.bar-fill{height:100%;border-radius:100px;transition:width 1s cubic-bezier(.4,0,.2,1)}

/* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
.chat-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;height:580px;box-shadow:var(--card-shadow)}
.chat-hdr{background:linear-gradient(135deg,var(--primary),var(--secondary));padding:16px 20px;display:flex;align-items:center;gap:12px;color:#fff}
.chat-av{width:38px;height:38px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.chat-hdr h3{font-size:15px;font-weight:700;color:#fff}
.chat-hdr p{font-size:11px;opacity:.8}
.chat-online{width:9px;height:9px;background:#4ade80;border-radius:50%;margin-left:auto;box-shadow:0 0 0 3px rgba(74,222,128,.3);animation:pulse 2s infinite}
.msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.msg{display:flex;gap:9px;max-width:84%}
.msg.bot{align-self:flex-start}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-av{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;color:#fff}
.bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55}
.bot .bubble{background:var(--surface3);color:var(--text);border-bottom-left-radius:4px;border:1px solid var(--border)}
.user .bubble{background:linear-gradient(135deg,var(--primary),var(--primary-l));color:#fff;border-bottom-right-radius:4px}
.typing span{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--text4);margin:0 2px;animation:bounce .8s infinite}
.typing span:nth-child(2){animation-delay:.15s}
.typing span:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}
.chat-in{padding:12px;border-top:1px solid var(--border);display:flex;gap:9px;background:var(--surface)}
.chat-in input{flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:inherit;font-size:13px;outline:none}
.chat-in input:focus{border-color:var(--primary);background:#fff}
.send-btn{background:linear-gradient(135deg,var(--primary),var(--primary-l));border:none;border-radius:10px;padding:10px 16px;color:#fff;cursor:pointer;font-size:16px;transition:.2s}
.send-btn:hover{transform:scale(1.05)}

/* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
.upload-z{border:2px dashed var(--border2);border-radius:var(--radius);padding:32px;text-align:center;cursor:pointer;transition:.25s;background:var(--surface2)}
.upload-z:hover{border-color:var(--primary);background:var(--primary-xl)}

/* ‚îÄ‚îÄ RISK MODULE ‚îÄ‚îÄ */
.urgency-banner{padding:16px 20px;border-radius:12px;display:flex;align-items:center;gap:14px;margin-bottom:14px}
.urg-critical{background:linear-gradient(135deg,rgba(220,38,38,.1),rgba(220,38,38,.05));border:1.5px solid rgba(220,38,38,.3);animation:urgBlink 2s infinite}
.urg-high{background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.25)}
.urg-medium{background:rgba(217,119,6,.06);border:1px solid rgba(217,119,6,.25)}
.urg-low{background:rgba(5,150,105,.06);border:1px solid rgba(5,150,105,.25)}
@keyframes urgBlink{0%,100%{border-color:rgba(220,38,38,.3)}50%{border-color:rgba(220,38,38,.7)}}
.risk-score-ring{position:relative;width:110px;height:110px;flex-shrink:0}
.risk-score-ring svg{transform:rotate(-90deg)}
.risk-score-ring .score-txt{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.risk-factors-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.risk-factor{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;border-left:3px solid transparent}
.rf-high{border-left-color:var(--danger)}
.rf-medium{border-left-color:var(--warn)}
.rf-low{border-left-color:var(--accent)}
.treatment-link{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--primary-xl);border:1px solid rgba(37,99,235,.2);border-radius:9px;color:var(--primary);font-size:13px;font-weight:600;cursor:pointer;text-decoration:none;transition:.2s;margin-bottom:8px}
.treatment-link:hover{background:var(--primary);color:#fff}

/* ‚îÄ‚îÄ SCAN STORAGE ‚îÄ‚îÄ */
.scan-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);transition:.2s}
.scan-card:hover{box-shadow:var(--card-shadow-h)}
.scan-thumb{height:140px;background:linear-gradient(135deg,var(--surface3),var(--surface2));display:flex;align-items:center;justify-content:center;font-size:48px;border-bottom:1px solid var(--border);cursor:pointer}
.scan-info{padding:12px}
.scan-info h4{font-size:13px;font-weight:700;margin-bottom:4px}
.scan-badge-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}

/* ‚îÄ‚îÄ ADR MODULE ‚îÄ‚îÄ */
.adr-alert{background:var(--danger-l);border:1.5px solid rgba(220,38,38,.3);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;gap:14px;align-items:flex-start}
.adr-icon{width:36px;height:36px;background:var(--danger);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.adr-mild{background:#fffbeb;border-color:rgba(217,119,6,.3)}
.adr-mild .adr-icon{background:var(--warn)}
.adr-info{background:var(--primary-xl);border-color:rgba(37,99,235,.2)}
.adr-info .adr-icon{background:var(--primary)}
.drug-combo-row{display:flex;align-items:center;gap:10px;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin-bottom:8px}

/* ‚îÄ‚îÄ SOURCE LINK ‚îÄ‚îÄ */
.source-link{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;text-decoration:none;color:var(--text2);font-size:12px;transition:.15s;margin-bottom:6px}
.source-link:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xl)}
.source-link .src-icon{width:20px;height:20px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}

/* ‚îÄ‚îÄ PRE / CODE ‚îÄ‚îÄ */
pre{background:var(--text);color:#86efac;border-radius:10px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:11px;line-height:1.7;overflow:auto;max-height:340px}
code{font-family:'JetBrains Mono',monospace;font-size:12px;background:var(--surface3);padding:2px 6px;border-radius:4px;color:var(--primary)}

/* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
.divider{height:1px;background:var(--border);margin:28px 0}

/* ‚îÄ‚îÄ HOME HERO ‚îÄ‚îÄ */
.hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:40px;align-items:center;margin-top:40px}
@media(max-width:768px){.hero-grid{grid-template-columns:1fr}.hero-visual{display:none}}
.feature-pill{display:flex;align-items:center;gap:10px;padding:12px 18px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--card-shadow);margin-bottom:10px;font-size:13px;font-weight:600;color:var(--text2)}
.feature-pill-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.hero-stat{display:flex;flex-direction:column;align-items:center;padding:24px;background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:var(--card-shadow)}
.hero-stat-val{font-family:'Fraunces',serif;font-size:32px;font-weight:700;color:var(--primary)}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:8000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.modal-backdrop.open{display:flex}
.modal{background:var(--surface);border-radius:var(--radius);padding:28px;width:100%;max-width:560px;box-shadow:0 24px 60px rgba(0,0,0,.2);max-height:85vh;overflow-y:auto}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-close{background:var(--surface3);border:none;border-radius:8px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}

/* ‚îÄ‚îÄ WELLNESS TAB ‚îÄ‚îÄ */
.wellness-tab-nav{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.wtab-btn{padding:8px 16px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--text3);transition:.2s}
.wtab-btn.active{background:var(--primary-xl);border-color:var(--primary);color:var(--primary)}
.wtab-content{display:none}
.wtab-content.active{display:block}
.doc-tab-content{display:none;animation:fadeUp .3s ease}
.doc-tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ RAG ‚îÄ‚îÄ */
.rag-source{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.rag-src-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.rag-src-badge{width:22px;height:22px;background:var(--primary-xl);color:var(--primary);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;flex-shrink:0}
.rag-answer-block{background:linear-gradient(135deg,var(--primary-xl),rgba(14,165,233,.06));border:1px solid rgba(37,99,235,.2);border-radius:12px;padding:18px;margin-bottom:16px}

/* ‚îÄ‚îÄ URGENCY TABLE ‚îÄ‚îÄ */
.critical-row td{background:rgba(220,38,38,.04)}
.critical-row:hover td{background:rgba(220,38,38,.08) !important}

/* ‚îÄ‚îÄ PAGINATION / CHIPS ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--surface);border:1px solid var(--border);border-radius:100px;font-size:12.5px;font-weight:600;cursor:pointer;color:var(--text3);transition:.2s}
.chip:hover,.chip.sel{background:var(--primary-xl);border-color:var(--primary);color:var(--primary)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:700px){.g2,.g3,.g4,.g-stat{grid-template-columns:1fr}.fgrid{grid-template-columns:1fr}nav button{font-size:11px;padding:5px 7px}.container{padding:0 16px}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">‚¨°</div>
      <div class="login-logo-text">Medi<span>Sync</span> AI</div>
    </div>
    <div id="login-err"></div>
    <div id="login-form-section">
      <h2 class="login-title" style="font-family:'Fraunces',serif">Welcome back</h2>
      <p class="login-sub">Sign in to your healthcare platform</p>
      
      <div class="login-field"><label>Email Address</label><input type="email" id="l-email" placeholder="doctor@hospital.com" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <div class="login-field"><label>Password</label><input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')doLogin()"></div>
      <button class="btn-login" onclick="doLogin()">Sign In</button>
      <div class="login-toggle">Don't have an account? <a onclick="toggleRegister()">Create one</a></div>
    </div>
    <div id="register-form-section" style="display:none">
      <h2 class="login-title" style="font-family:'Fraunces',serif">Create account</h2>
      <p class="login-sub">Join MediSync AI platform</p>
      <div class="login-field"><label>Full Name</label><input type="text" id="r-name" placeholder="Dr. John Smith"></div>
      <div class="login-field"><label>Email Address</label><input type="email" id="r-email" placeholder="doctor@hospital.com"></div>
      <div class="login-field"><label>Password</label><input type="password" id="r-pass" placeholder="Minimum 8 characters"></div>
      <div class="login-field"><label>Role</label>
        <select class="inp" id="r-role" style="background:#f8fafc;border:1.5px solid #dde3ec">
          <option value="physician">Physician / Doctor</option>
          <option value="nurse">Nurse / Clinician</option>
          <option value="admin">Healthcare Admin</option>
          <option value="researcher">Medical Researcher</option>
        </select>
      </div>
      <button class="btn-login" onclick="doRegister()">Create Account</button>
      <div class="login-toggle">Already have an account? <a onclick="toggleRegister()">Sign in</a></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav id="main-nav" style="display:none">
  <div class="nav-logo" onclick="go('home')">
    <div class="nav-logo-icon">‚¨°</div>
    Medi<span>Sync</span> AI
  </div>
  <button id="nb-home" onclick="go('home')" class="active">Home</button>
  <button id="nb-docs" onclick="go('docs')">üìñ Documentation</button>
  <button id="nb-mental" onclick="go('mental')">üß† WellnessBot</button>
  <button id="nb-rag" onclick="go('rag')">üîç MedRAG</button>
  <button id="nb-rx" onclick="go('rx')">üíä Prescriptions</button>
  <button id="nb-scans" onclick="go('scans')">ü©ª Scans</button>
  <button id="nb-risk" onclick="go('risk')">‚öïÔ∏è Risk AI</button>
  <button id="nb-adr" onclick="go('adr')">‚ö†Ô∏è ADR</button>
  <button id="nb-dashboard" onclick="go('dashboard')">üìä Dashboard</button>
  <button id="nb-report" onclick="go('report')">üìë Reports</button>
  <div style="flex:1"></div>
  <button id="nb-history" onclick="showAllHistory()" style="background:var(--surface2);border:1px solid var(--border);font-weight:700;color:var(--primary)">üïê History</button>
  <div id="adr-nav-badge" class="nav-alert-badge">!</div>
  <div class="nav-user" onclick="showLogout()">
    <div class="nav-avatar" id="nav-av-initials">DR</div>
    <span id="nav-username">Dr. User</span>
  </div>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USER PROFILE MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="user-modal">
  <div class="modal" style="max-width:500px;max-height:85vh;overflow-y:auto;text-align:center">
    <div style="font-size:44px;margin-bottom:10px">üë§</div>
    <h3 id="user-modal-name" style="margin-bottom:2px"></h3>
    <div id="user-modal-email" class="muted" style="font-size:13px;margin-bottom:18px"></div>
    
    <div id="user-dashboard-stats" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;text-align:left">
    </div>
    
    <div id="user-dashboard-activity" style="text-align:left;margin-bottom:18px">
    </div>
    
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn-p" onclick="go('dashboard');closeUserModal()">Main Dashboard</button>
      <button class="btn-s" onclick="doLogout()">Sign Out</button>
      <button class="btn-s" onclick="closeUserModal()">Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPREHENSIVE HISTORY MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="all-history-modal" style="display:none">
  <div class="modal" style="max-width:800px;max-height:90vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <h3>üïê Activity History</h3>
        <p class="muted" style="font-size:12px;margin-top:4px">All your actions across MediSync AI platform</p>
      </div>
      <button class="btn-s" onclick="closeAllHistory()" style="font-size:12px">‚úï Close</button>
    </div>
    
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap" id="history-filters">
      <button class="chip sel" onclick="filterHistory('all')">All</button>
      <button class="chip" onclick="filterHistory('wellness_chat')">üß† Wellness</button>
      <button class="chip" onclick="filterHistory('prescription')">üíä Prescriptions</button>
      <button class="chip" onclick="filterHistory('scan')">ü©ª Scans</button>
      <button class="chip" onclick="filterHistory('risk_prediction')">‚öïÔ∏è Risk</button>
      <button class="chip" onclick="filterHistory('adr_report')">‚ö†Ô∏è ADR</button>
      <button class="chip" onclick="filterHistory('medrag_query')">üîç MedRAG</button>
    </div>
    
    <div style="flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;background:var(--surface2)">
      <div id="all-history-list" style="display:flex;flex-direction:column;gap:8px">
        <div style="text-align:center;padding:20px;color:var(--text3)">
          <div class="spinner" style="width:24px;height:24px;border-width:3px;display:block;margin:0 auto;margin-bottom:8px"></div>
          Loading activity history‚Ä¶
        </div>
      </div>
    </div>
    <div style="padding:12px;background:var(--surface2);border-radius:10px;font-size:12px;color:var(--text3)">
      üí° Click on any wellness chat session to restore and view the full conversation.
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WELLNESS CHAT HISTORY MODAL (Legacy) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="history-modal" style="display:none">
  <div class="modal" style="max-width:600px;max-height:90vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3>üìú Wellness Chat History</h3>
      <button class="btn-s" onclick="closeHistoryPanel()" style="font-size:12px">‚úï Close</button>
    </div>
    <div style="flex:1;overflow-y:auto;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;background:var(--surface2)">
      <div id="history-list" style="display:flex;flex-direction:column;gap:8px">
        <div style="text-align:center;padding:20px;color:var(--text3)">
          <div class="spinner" style="width:20px;height:20px;border-width:2px;display:block;margin:0 auto;margin-bottom:8px"></div>
          Loading chat history‚Ä¶
        </div>
      </div>
    </div>
    <div style="padding:12px;background:var(--surface2);border-radius:10px;font-size:12px;color:var(--text3)">
      üí° Click on any session to view the full conversation and re-render it in the chat above.
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DOCUMENTATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-docs" style="display:none">
 <div class="container">
  <div class="page-header">
    <div class="pill">üìñ Documentation</div>
    <h2>MediSync AI <span style="color:var(--primary)">Platform Guide</span></h2>
    <p class="muted" style="max-width:520px">Unified Healthcare Intelligence Platform for EHR, AI chat, risk analytics, and more.</p>
  </div>

  <div class="wellness-tab-nav" style="margin-bottom:24px">
    <button class="wtab-btn active" onclick="switchDocTab('what')">‚ùì What is MediSync</button>
    <button class="wtab-btn" onclick="switchDocTab('about')">‚ÑπÔ∏è About</button>
    <button class="wtab-btn" onclick="switchDocTab('how')">‚öôÔ∏è How it works</button>
    <button class="wtab-btn" onclick="switchDocTab('features')">üöÄ Features</button>
    <button class="wtab-btn" onclick="switchDocTab('agents')">ü§ñ Agent Types</button>
  </div>

  <!-- Tab: What is MediSync -->
  <div class="doc-tab-content active" id="dt-what">
    <div class="card">
      <h3 style="margin-bottom:12px;font-size:18px">What is MediSync AI?</h3>
      <p style="line-height:1.6;margin-bottom:16px">MediSync AI is an integrated healthcare platform that combines electronic health records (EHR), AI-powered chatbots, risk prediction, prescription management, scan storage, and more. It is designed for clinicians, researchers, and healthcare admins to streamline workflows and improve patient care.</p>
      <div class="g2">
        <div class="card card-sm ci-blue" style="border:none">
          <h4 style="margin-bottom:8px">Mission</h4>
          <p class="muted" style="font-size:13px">To bridge the gap between complex medical data and actionable clinical intelligence using state-of-the-art AI.</p>
        </div>
        <div class="card card-sm ci-green" style="border:none">
          <h4 style="margin-bottom:8px">Vision</h4>
          <p class="muted" style="font-size:13px">A future where every clinician has an AI co-pilot to ensure zero errors and personalized patient care.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: About -->
  <div class="doc-tab-content" id="dt-about">
    <div class="card">
      <h3 style="margin-bottom:12px;font-size:18px">About the Platform</h3>
      <p style="line-height:1.6;margin-bottom:16px">MediSync AI v3.0 represents the pinnacle of healthcare interoperability. Built on a foundation of security and clinical accuracy, it provides a centralized hub for all medical operations.</p>
      <div class="field">
        <label>Tech Stack</label>
        <ul style="font-size:14px;padding-left:20px;margin-top:8px">
          <li><strong>Backend:</strong> FastAPI (Python), JWT, bcrypt, Pydantic</li>
          <li><strong>Frontend:</strong> Single Page App (HTML, CSS, JS)</li>
          <li><strong>Data:</strong> JSON file storage (can be upgraded to a database)</li>
        </ul>
      </div>
      <div class="field" style="margin-top:16px">
        <label>Compliance & Security</label>
        <p class="muted" style="font-size:13px">The platform implements FHIR R4 standards for data interoperability and uses industry-standard encryption for all data at rest and in transit.</p>
      </div>
    </div>
  </div>

  <!-- Tab: How it works -->
  <div class="doc-tab-content" id="dt-how">
    <div class="card">
      <h3 style="margin-bottom:12px;font-size:18px">How it works</h3>
      <div class="g2">
        <div>
          <h4 style="margin-bottom:10px">User Workflow</h4>
          <ol style="font-size:14px;padding-left:20px;display:flex;flex-direction:column;gap:10px">
            <li><strong>Authentication:</strong> Secure login or registration with JWT-based session management.</li>
            <li><strong>Data Entry:</strong> Upload prescriptions, medical scans, or input clinical parameters.</li>
            <li><strong>AI Analysis:</strong> Specialized agents process the data (e.g., Risk AI for CVD, ADR for drug interactions).</li>
            <li><strong>Actionable Insights:</strong> Receive prioritized alerts, standardized FHIR records, and treatment links.</li>
          </ol>
        </div>
        <div class="card card-sm" style="background:var(--surface2)">
          <h4 style="margin-bottom:10px">System Architecture</h4>
          <p class="muted" style="font-size:13px">A stateless FastAPI backend communicates with a rich JavaScript frontend. Data is persisted in JSON format, ensuring easy portability and human-readability of clinical records.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Features -->
  <div class="doc-tab-content" id="dt-features">
    <div class="g2">
      <div class="card">
        <h4 style="margin-bottom:12px">Core Modules</h4>
        <ul style="font-size:13.5px;padding-left:20px;display:flex;flex-direction:column;gap:8px">
          <li><strong>MedRAG:</strong> Universal Medical Knowledge Retrieval.</li>
          <li><strong>WellnessBot:</strong> CBT-based mental health support.</li>
          <li><strong>Prescription AI:</strong> FHIR standardization & multi-format export.</li>
          <li><strong>Scan Storage:</strong> DICOM-compatible medical imaging vault.</li>
          <li><strong>Risk AI:</strong> Explainable cardiovascular risk scoring.</li>
          <li><strong>ADR Detection:</strong> Real-time drug-drug interaction alerts.</li>
        </ul>
      </div>
      <div class="card">
        <h4 style="margin-bottom:12px">Connectivity</h4>
        <ul style="font-size:13.5px;padding-left:20px;display:flex;flex-direction:column;gap:8px">
          <li><strong>API:</strong> RESTful endpoints for third-party integration.</li>
          <li><strong>Export:</strong> Generate comprehensive PDF, JSON, and HTML reports.</li>
          <li><strong>External:</strong> Direct links to PubMed, Google Scholar, and clinical guidelines.</li>
          <li><strong>Real-time:</strong> Live dashboard analytics and urgent triage queue.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Tab: Agent Types -->
  <div class="doc-tab-content" id="dt-agents">
    <div class="card" style="margin-bottom:20px">
      <h3 style="margin-bottom:12px;font-size:18px">Artificial Intelligence Agents</h3>
      <p class="muted" style="margin-bottom:20px">MediSync AI utilizes specialized agent architectures tailored for specific clinical tasks.</p>
      
      <div class="g2">
        <div class="card card-sm" style="border-left:4px solid var(--primary)">
          <h4 style="color:var(--primary);margin-bottom:6px">RAG Agents (MedRAG)</h4>
          <p style="font-size:13px;line-height:1.5"><strong>Type:</strong> Retrieval-Augmented Generation.<br>Uses a 4-stage retrieval system to fetch evidence-based guidelines from WHO, CDC, and NICE before generating clinical responses. Ensures zero hallucination for known diseases.</p>
        </div>
        <div class="card card-sm" style="border-left:4px solid var(--purple)">
          <h4 style="color:var(--purple);margin-bottom:6px">Conversational Agents</h4>
          <p style="font-size:13px;line-height:1.5"><strong>Type:</strong> Rule-based + LLM Hybrid.<br>The WellnessBot uses CBT (Cognitive Behavioral Therapy) frameworks to provide empathetic, non-linear support for mental health concerns, including crisis detection.</p>
        </div>
        <div class="card card-sm" style="border-left:4px solid var(--warn)">
          <h4 style="color:var(--warn);margin-bottom:6px">Predictive Agents</h4>
          <p style="font-size:13px;line-height:1.5"><strong>Type:</strong> Deterministic Clinical Models.<br>Risk AI agents use mathematical scoring systems (based on Framingham/ESC models) to provide explainable risk factors and urgency triage levels.</p>
        </div>
        <div class="card card-sm" style="border-left:4px solid var(--danger)">
          <h4 style="color:var(--danger);margin-bottom:6px">Security Agents</h4>
          <p style="font-size:13px;line-height:1.5"><strong>Type:</strong> Validator Agents.<br>Handle ADR (Adverse Drug Reaction) detection by cross-referencing input drugs against a validated interaction database in real-time.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-sm" style="margin-top:20px;background:var(--surface2)">
    <p style="font-size:13px;text-align:center">For further support, see the <strong>README.md</strong> or contact <strong>support@medisync.ai</strong></p>
  </div>
 </div>
</div>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-home">
 <div class="container">
  <div style="padding-top:20px">
    <div id="api-badge" class="api-badge api-off" style="margin-bottom:20px">
      <span class="dot dot-r" id="api-dot"></span>
      <span id="api-txt">Checking API‚Ä¶</span>
    </div>
    <div class="pill">‚¨° Healthcare Intelligence Platform v3.0</div>
    <h1 style="margin:14px 0 18px;max-width:680px">Unified <span style="color:var(--primary)">AI-Powered</span><br>Clinical Intelligence</h1>
    <p class="muted" style="max-width:540px;font-size:15px;margin-bottom:32px">Interoperable EHR management, mental health support, predictive risk analytics, ADR detection, and RAG knowledge retrieval ‚Äî one unified platform.</p>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:56px">
      <button class="btn-p" onclick="go('mental')">üß† WellnessBot</button>
      <button class="btn-s" onclick="go('risk')">‚öïÔ∏è Risk Prediction</button>
      <button class="btn-s" onclick="go('adr')">‚ö†Ô∏è ADR Detection</button>
    </div>
  </div>
  <div class="g4" style="margin-bottom:48px">
    <div class="stat-card"><div class="stat-val" id="h-stat1">‚Äî</div><div class="stat-lbl">Prescriptions Stored</div></div>
    <div class="stat-card"><div class="stat-val" id="h-stat2">‚Äî</div><div class="stat-lbl">Risk Predictions</div></div>
    <div class="stat-card"><div class="stat-val" id="h-stat3">‚Äî</div><div class="stat-lbl">Chat Sessions</div></div>
    <div class="stat-card"><div class="stat-val" id="h-stat4">‚Äî</div><div class="stat-lbl">ADR Alerts</div></div>
  </div>
  <h2 style="margin-bottom:20px">Platform <span style="color:var(--primary)">Modules</span></h2>
  <div class="g3">
    <div class="card" style="cursor:pointer" onclick="go('mental')"><div class="card-header"><div class="card-icon ci-purple">üß†</div><h3>WellnessBot</h3></div><p class="muted" style="font-size:13px">Woebot & Wysa-inspired mental health AI ‚Äî CBT-based support, mood tracking, crisis signposting.</p></div>
    <div class="card" style="cursor:pointer" onclick="go('rag')"><div class="card-header"><div class="card-icon ci-blue">üîç</div><h3>MedRAG Agent</h3></div><p class="muted" style="font-size:13px">August AI-inspired medical knowledge retrieval with cited WHO/CDC/NICE/ADA sources and links.</p></div>
    <div class="card" style="cursor:pointer" onclick="go('rx')"><div class="card-header"><div class="card-icon ci-green">üíä</div><h3>Prescription AI</h3></div><p class="muted" style="font-size:13px">Standardize prescriptions to FHIR R4 JSON. Store as PDF, JPEG, PNG, DOCX.</p></div>
    <div class="card" style="cursor:pointer" onclick="go('scans')"><div class="card-header"><div class="card-icon ci-blue">ü©ª</div><h3>Scan Storage</h3></div><p class="muted" style="font-size:13px">Upload & store MRI, X-Ray, CT, Ultrasound scans in multiple formats with patient linking.</p></div>
    <div class="card" style="cursor:pointer" onclick="go('risk')"><div class="card-header"><div class="card-icon ci-yellow">‚öïÔ∏è</div><h3>Risk AI (Modular)</h3></div><p class="muted" style="font-size:13px">Explainable multi-factor risk scoring. Urgency triage ‚Äî flags patients needing immediate care.</p></div>
    <div class="card" style="cursor:pointer" onclick="go('adr')"><div class="card-header"><div class="card-icon ci-red">‚ö†Ô∏è</div><h3>ADR Detection</h3></div><p class="muted" style="font-size:13px">Real-time Adverse Drug Reaction detection using EHR data. Drug interaction checker.</p></div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WELLNESS BOT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-mental">
 <div class="container">
  <div class="page-header">
    <div class="pill">üß† Mental Health AI</div>
    <h2>WellnessBot <span style="color:var(--primary)">MindCare</span></h2>
    <p class="muted" style="max-width:520px">Inspired by Woebot & Wysa ‚Äî CBT-based empathetic support, mood tracking & crisis guidance.</p>
  </div>
  <div class="wellness-tab-nav">
    <button class="wtab-btn active" onclick="switchWTab('chat')">üí¨ Chat Support</button>
    <button class="wtab-btn" onclick="switchWTab('mood')">üìä Mood Tracker</button>
    <button class="wtab-btn" onclick="switchWTab('cbt')">üß© CBT Exercises</button>
    <button class="wtab-btn" onclick="switchWTab('crisis')">üÜò Crisis Resources</button>
  </div>

  <div class="wtab-content active" id="wt-chat">
   <div class="g2">
    <div class="chat-wrap">
      <div class="chat-hdr">
        <div class="chat-av">üåø</div>
        <div><h3>MindCare AI</h3><p>CBT-based ‚Ä¢ Empathetic ‚Ä¢ Confidential</p></div>
        <button class="btn-s" onclick="showHistoryPanel()" style="margin-left:auto;font-size:11px;padding:6px 10px">üìú History</button>
        <div class="chat-online"></div>
      </div>
      <div class="msgs" id="well-msgs">
        <div class="msg bot"><div class="msg-av">üåø</div><div class="bubble">Hello! I'm MindCare AI, your personal wellness companion üå±<br><br>I use evidence-based CBT techniques (like Woebot & Wysa) to help you manage stress, anxiety, and difficult emotions. Everything you share is private.<br><br>How are you feeling today?</div></div>
      </div>
      <div class="chat-in">
        <input id="well-inp" placeholder="Share how you're feeling‚Ä¶" onkeypress="if(event.key==='Enter')sendWellness()">
        <button class="send-btn" onclick="sendWellness()">‚û§</button>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="card card-sm">
        <h3 style="margin-bottom:10px">üéØ Quick Check-in</h3>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <button onclick="wellQuick('I feel anxious and overwhelmed')" class="chip">Anxious üò∞</button>
          <button onclick="wellQuick('I am feeling depressed and low')" class="chip">Low mood üòî</button>
          <button onclick="wellQuick('I cannot sleep well')" class="chip">Sleep issues üò¥</button>
          <button onclick="wellQuick('I am very stressed with work')" class="chip">Work stress üíº</button>
          <button onclick="wellQuick('I feel lonely and isolated')" class="chip">Lonely üíô</button>
          <button onclick="wellQuick('I am having a panic attack')" class="chip">Panic üò±</button>
        </div>
      </div>
      <div class="card card-sm">
        <h3 style="margin-bottom:10px">üåø MindCare Features</h3>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;gap:8px;align-items:center;font-size:13px;color:var(--text2);padding:7px 0;border-bottom:1px solid var(--border)"><span>üß†</span> Cognitive Behavioural Therapy (CBT)</div>
          <div style="display:flex;gap:8px;align-items:center;font-size:13px;color:var(--text2);padding:7px 0;border-bottom:1px solid var(--border)"><span>üìä</span> Daily mood & symptom tracking</div>
          <div style="display:flex;gap:8px;align-items:center;font-size:13px;color:var(--text2);padding:7px 0;border-bottom:1px solid var(--border)"><span>üå¨Ô∏è</span> Guided breathing exercises</div>
          <div style="display:flex;gap:8px;align-items:center;font-size:13px;color:var(--text2);padding:7px 0"><span>üÜò</span> Crisis signposting & helplines</div>
        </div>
      </div>
      <div class="alert al-i show" style="font-size:12px">‚ÑπÔ∏è MindCare AI supports wellbeing but is not a replacement for professional mental healthcare. In crisis, call 988 (US) or your local emergency services.</div>
    </div>
   </div>
  </div>

  <div class="wtab-content" id="wt-mood">
   <div class="card" style="margin-bottom:20px">
    <h3 style="margin-bottom:16px">üìä Today's Mood Check-in</h3>
    <p class="muted" style="font-size:13px;margin-bottom:16px">How are you feeling right now? Rate each dimension:</p>
    <div class="fgrid">
      <div class="field"><label>Overall Mood (1‚Äì10)</label><input class="inp" type="range" min="1" max="10" value="5" id="mood-overall" oninput="document.getElementById('mood-ov-val').textContent=this.value"> <span style="font-size:13px;font-weight:700;color:var(--primary)" id="mood-ov-val">5</span></div>
      <div class="field"><label>Anxiety Level (1‚Äì10)</label><input class="inp" type="range" min="1" max="10" value="3" id="mood-anx" oninput="document.getElementById('mood-ax-val').textContent=this.value"> <span style="font-size:13px;font-weight:700;color:var(--warn)" id="mood-ax-val">3</span></div>
      <div class="field"><label>Energy Level (1‚Äì10)</label><input class="inp" type="range" min="1" max="10" value="6" id="mood-energy" oninput="document.getElementById('mood-en-val').textContent=this.value"> <span style="font-size:13px;font-weight:700;color:var(--accent)" id="mood-en-val">6</span></div>
      <div class="field"><label>Sleep Quality (1‚Äì10)</label><input class="inp" type="range" min="1" max="10" value="7" id="mood-sleep" oninput="document.getElementById('mood-sl-val').textContent=this.value"> <span style="font-size:13px;font-weight:700;color:var(--secondary)" id="mood-sl-val">7</span></div>
    </div>
    <div class="field" style="margin-top:8px"><label>Notes (optional)</label><textarea class="inp" id="mood-notes" rows="2" placeholder="Any notes about your day‚Ä¶"></textarea></div>
    <button class="btn-p" onclick="saveMoodEntry()" style="margin-top:12px">üíæ Log Mood Entry</button>
   </div>
   <div class="card">
    <h3 style="margin-bottom:14px">üìà Mood History</h3>
    <div id="mood-history-list">
      <p class="muted" style="text-align:center;padding:24px;font-size:13px">No entries yet. Log your first mood above!</p>
    </div>
   </div>
  </div>

  <div class="wtab-content" id="wt-cbt">
   <div class="g2">
    <div class="card"><div class="card-header"><div class="card-icon ci-purple">üå¨Ô∏è</div><h3>4-7-8 Breathing</h3></div><p class="muted" style="font-size:13px;margin-bottom:14px">Activates your parasympathetic nervous system, reducing stress hormones within minutes.</p><div id="breathing-timer" style="text-align:center;padding:20px;background:var(--surface3);border-radius:10px;font-family:'Fraunces',serif;font-size:42px;color:var(--primary)">4</div><p id="breathing-label" style="text-align:center;color:var(--text3);font-size:13px;margin-top:8px">Press Start to begin</p><button class="btn-p" onclick="startBreathing()" id="breath-btn" style="width:100%;margin-top:12px">‚ñ∂ Start Exercise</button></div>
    <div class="card"><div class="card-header"><div class="card-icon ci-blue">‚úçÔ∏è</div><h3>Thought Record (CBT)</h3></div><p class="muted" style="font-size:13px;margin-bottom:14px">Identify and challenge negative automatic thoughts ‚Äî a core CBT technique.</p><div class="field"><label>Triggering Situation</label><input class="inp" id="cbt-sit" placeholder="What happened?"></div><div class="field"><label>Automatic Thought</label><input class="inp" id="cbt-thought" placeholder="What went through your mind?"></div><div class="field"><label>Emotion & Intensity</label><input class="inp" id="cbt-emotion" placeholder="e.g. Anxiety 7/10"></div><div class="field"><label>Evidence For / Against</label><textarea class="inp" rows="2" id="cbt-evidence" placeholder="What facts support or challenge this thought?"></textarea></div><button class="btn-p" onclick="analyzeCBT()" style="width:100%;margin-top:4px">üß† Analyze with AI</button></div>
    <div class="card"><div class="card-header"><div class="card-icon ci-green">üôè</div><h3>Gratitude Journal</h3></div><p class="muted" style="font-size:13px;margin-bottom:14px">Research shows gratitude journaling improves wellbeing scores by up to 35%.</p><div class="field"><label>3 Things I'm Grateful For Today</label><textarea class="inp" rows="5" id="gratitude-text" placeholder="1. ...&#10;2. ...&#10;3. ..."></textarea></div><button class="btn-p" onclick="saveGratitude()" style="width:100%;margin-top:8px">üíæ Save Entry</button><div id="gratitude-ok" class="alert al-s" style="margin-top:10px"></div></div>
    <div class="card"><div class="card-header"><div class="card-icon ci-yellow">üéØ</div><h3>Mindfulness Check</h3></div><p class="muted" style="font-size:13px;margin-bottom:14px">5-4-3-2-1 grounding technique for anxiety and dissociation.</p><div id="mindfulness-steps" style="display:flex;flex-direction:column;gap:8px"><div style="padding:10px 14px;background:var(--surface3);border-radius:9px;font-size:13px"><strong style="color:var(--primary)">5</strong> things you can <strong>SEE</strong> right now</div><div style="padding:10px 14px;background:var(--surface3);border-radius:9px;font-size:13px"><strong style="color:var(--primary)">4</strong> things you can <strong>TOUCH</strong></div><div style="padding:10px 14px;background:var(--surface3);border-radius:9px;font-size:13px"><strong style="color:var(--primary)">3</strong> things you can <strong>HEAR</strong></div><div style="padding:10px 14px;background:var(--surface3);border-radius:9px;font-size:13px"><strong style="color:var(--primary)">2</strong> things you can <strong>SMELL</strong></div><div style="padding:10px 14px;background:var(--surface3);border-radius:9px;font-size:13px"><strong style="color:var(--primary)">1</strong> thing you can <strong>TASTE</strong></div></div></div>
   </div>
  </div>

  <div class="wtab-content" id="wt-crisis">
   <div class="alert al-e show" style="margin-bottom:20px;font-size:13px">üÜò If you're in immediate danger, call <strong>emergency services (911/999)</strong> right now. Below are confidential mental health resources.</div>
   <div class="g2">
    <div class="card"><h3 style="margin-bottom:14px">üá∫üá∏ United States</h3>
      <a href="tel:988" class="treatment-link">üìû 988 Suicide & Crisis Lifeline ‚Äî Call or text 988</a>
      <a href="https://suicidepreventionlifeline.org" target="_blank" class="treatment-link">üåê suicidepreventionlifeline.org</a>
      <a href="https://www.crisistextline.org" target="_blank" class="treatment-link">üí¨ Crisis Text Line ‚Äî Text HOME to 741741</a>
    </div>
    <div class="card"><h3 style="margin-bottom:14px">üåç International</h3>
      <a href="https://www.befrienders.org" target="_blank" class="treatment-link">üåê Befrienders Worldwide</a>
      <a href="https://www.iasp.info/resources/Crisis_Centres/" target="_blank" class="treatment-link">üåê IASP Crisis Centres Directory</a>
      <a href="https://findahelpline.com" target="_blank" class="treatment-link">üåê Find a Helpline (Global)</a>
    </div>
    <div class="card"><h3 style="margin-bottom:14px">üì± Mental Health Apps</h3>
      <a href="https://woebothealth.com" target="_blank" class="treatment-link">ü§ñ Woebot ‚Äî CBT-based AI therapy</a>
      <a href="https://www.wysa.com" target="_blank" class="treatment-link">üêß Wysa ‚Äî Emotional wellbeing AI</a>
      <a href="https://www.headspace.com" target="_blank" class="treatment-link">üßò Headspace ‚Äî Mindfulness & sleep</a>
    </div>
    <div class="card"><h3 style="margin-bottom:14px">üìö Learn & Self-Help</h3>
      <a href="https://www.nimh.nih.gov/health/topics/mental-health" target="_blank" class="treatment-link">üìñ NIH Mental Health Topics</a>
      <a href="https://www.who.int/health-topics/mental-health" target="_blank" class="treatment-link">üìñ WHO Mental Health</a>
      <a href="https://www.nhs.uk/mental-health" target="_blank" class="treatment-link">üìñ NHS Mental Health Resources</a>
    </div>
   </div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MedRAG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-rag">
 <div class="container">
  <div class="page-header">
    <div class="pill">üîç Knowledge Retrieval</div>
    <h2>MedRAG <span style="color:var(--primary)">Knowledge Agent</span></h2>
    <p class="muted" style="max-width:520px">August AI-inspired medical knowledge retrieval with cited WHO, CDC, NICE, ADA, ACC/AHA sources. <strong>Ask about ANY disease</strong> ‚Äî covers 50+ conditions with intelligent fallback for all others.</p>
  </div>
  <div class="g2">
   <div style="display:flex;flex-direction:column;gap:16px">
    <div class="card">
      <h3 style="margin-bottom:12px">üîç Ask Medical Question</h3>
      <div class="alert al-i show" style="font-size:12px;margin-bottom:12px">‚ú® <strong>Ask about ANY disease or condition!</strong> MedRAG has 50+ curated answers and generates intelligent responses for all other queries using clinical guidelines.</div>
      <textarea class="inp" id="rag-q" rows="3" placeholder="e.g. First-line treatment for Type 2 Diabetes? Management of Crohn's disease? Treatment for Kawasaki disease?" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();searchRAG()}" style="resize:none"></textarea>
      <button class="btn-p" onclick="searchRAG()" style="margin-top:12px;width:100%" id="rag-btn">üîç Search Knowledge Base</button>
    </div>
    <div class="card card-sm">
      <h3 style="margin-bottom:10px">üí° Quick Queries</h3>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button onclick="ragQuick('first line treatment for Type 2 diabetes')" class="source-link">Type 2 Diabetes ‚Äî first-line treatment</button>
        <button onclick="ragQuick('symptoms of hypertensive crisis and treatment')" class="source-link">Hypertensive crisis management</button>
        <button onclick="ragQuick('cardiovascular health exercise guidelines')" class="source-link">Cardiovascular exercise guidelines</button>
        <button onclick="ragQuick('generalised anxiety disorder treatment')" class="source-link">Generalised anxiety disorder (GAD)</button>
        <button onclick="ragQuick('asthma management stepwise approach')" class="source-link">Asthma stepwise treatment</button>
        <button onclick="ragQuick('sepsis early warning signs and treatment')" class="source-link">Sepsis early warning & treatment</button>
        <button onclick="ragQuick('acute myocardial infarction management')" class="source-link">Acute MI / Heart attack management</button>
      </div>
    </div>
   </div>
   <div id="rag-result">
    <div class="card" style="text-align:center;padding:52px 28px">
      <div style="font-size:52px;margin-bottom:16px">üìö</div>
      <p class="muted">Ask a clinical question above to retrieve evidence-based answers with cited sources and direct links.</p>
    </div>
   </div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRESCRIPTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-rx">
 <div class="container">
  <div class="page-header">
    <div class="pill">üíä Prescription AI</div>
    <h2>Prescription <span style="color:var(--primary)">Management</span></h2>
    <p class="muted">Convert prescriptions to FHIR R4 JSON. Save prescriptions as PDF, JPEG, PNG, DOCX.</p>
  </div>
  <div class="g2" style="margin-bottom:32px">
    <div>
      <div class="upload-z" onclick="document.getElementById('rx-file').click()" id="rx-dropzone">
        <div style="font-size:40px;margin-bottom:10px">üìã</div>
        <div style="font-weight:700;margin-bottom:5px">Drop or Click to Upload</div>
        <p class="muted" style="font-size:12px">JPG ¬∑ PNG ¬∑ PDF ¬∑ TXT ¬∑ DOCX</p>
        <input type="file" id="rx-file" style="display:none" accept=".jpg,.jpeg,.png,.pdf,.txt,.docx" onchange="uploadRx(this)">
      </div>
      <div class="alert al-s" id="rx-upload-ok" style="margin-top:10px">‚úÖ Prescription uploaded and processed!</div>
      <div class="card" style="margin-top:14px">
        <h3 style="margin-bottom:14px">Or enter prescription details</h3>
        <div class="fgrid">
          <div class="field"><label>Patient Name</label><input class="inp" id="rx-patient" placeholder="John Doe"></div>
          <div class="field"><label>Physician</label><input class="inp" id="rx-physician" placeholder="Dr. A. Sharma"></div>
        </div>
        <div class="field"><label>Prescription Text</label><textarea class="inp" id="rx-text" rows="3" placeholder="Metformin 500mg twice daily for diabetes management‚Ä¶" style="resize:none"></textarea></div>
        <button class="btn-p" onclick="standardizeRx()" style="margin-top:10px;width:100%" id="rx-btn">‚ö° Standardize to FHIR R4</button>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <h3>üì§ FHIR R4 Output</h3><span class="tag tg-g">FHIR R4</span>
        </div>
        <pre id="rx-output">{
  "status": "Awaiting prescription input‚Ä¶",
  "format": "FHIR R4 MedicationRequest"
}</pre>
      </div>
      <div class="card card-sm" id="rx-save-panel" style="display:none">
        <h3 style="margin-bottom:12px">üíæ Save Prescription As</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="btn-s" onclick="saveRxAs('pdf')" style="justify-content:center">üìÑ PDF</button>
          <button class="btn-s" onclick="saveRxAs('json')" style="justify-content:center">üìã JSON</button>
          <button class="btn-s" onclick="saveRxAs('txt')" style="justify-content:center">üìù TXT</button>
          <button class="btn-s" onclick="saveRxAs('docx')" style="justify-content:center">üìÉ DOCX</button>
        </div>
      </div>
    </div>
  </div>
  <h2 style="margin-bottom:18px">Stored <span style="color:var(--primary)">Records</span></h2>
  <div class="g2" style="margin-bottom:32px">
    <div class="card">
      <h3 style="margin-bottom:14px">üîç Filter Prescriptions</h3>
      <div class="field"><label>Filter by Patient</label><input class="inp" id="rx-filter-patient" placeholder="Patient name‚Ä¶" oninput="renderPrescriptions()"></div>
      <div style="background:var(--surface3);border-radius:10px;padding:16px;margin-top:8px">
        <h4 style="font-size:13px;margin-bottom:10px;color:var(--text3)">Storage Stats</h4>
        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between">
          <div>
            <div><div style="font-size:20px;font-weight:800;color:var(--primary)" id="rx-count-total">0</div><div style="font-size:11px;color:var(--text3)">Total Prescriptions</div></div>
            <div style="margin-top:12px"><div style="font-size:20px;font-weight:800;color:var(--accent)" id="rx-count-uploaded">0</div><div style="font-size:11px;color:var(--text3)">Uploaded</div></div>
          </div>
          <button class="btn-s" onclick="loadPrescriptions()" style="height:fit-content">üîÑ Refresh</button>
        </div>
      </div>
    </div>
  </div>
  <div class="g3" id="rx-grid" style="min-height:100px">
    <div class="card" style="text-align:center;padding:28px;grid-column:1/-1"><p class="muted" style="font-size:13px">Loading prescriptions‚Ä¶</p></div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCANS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-scans">
 <div class="container">
  <div class="page-header">
    <div class="pill">ü©ª Medical Imaging</div>
    <h2>Scan <span style="color:var(--primary)">Storage & Management</span></h2>
    <p class="muted">Upload and manage MRI, X-Ray, CT, Ultrasound scans. Supports PDF, JPEG, PNG, DICOM, TIFF formats.</p>
  </div>
  <div class="g2" style="margin-bottom:28px">
   <div class="card">
    <h3 style="margin-bottom:14px">üì§ Upload New Scan</h3>
    <div class="upload-z" onclick="document.getElementById('scan-file').click()" style="padding:24px;margin-bottom:12px">
      <div style="font-size:36px;margin-bottom:8px">ü©ª</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Upload Scan Image</div>
      <p class="muted" style="font-size:12px">JPEG ¬∑ PNG ¬∑ PDF ¬∑ DICOM ¬∑ TIFF</p>
      <input type="file" id="scan-file" style="display:none" accept=".jpg,.jpeg,.png,.pdf,.tif,.tiff,.dcm" onchange="uploadScan(this)">
    </div>
    <div class="fgrid">
      <div class="field"><label>Patient Name</label><input class="inp" id="scan-patient" placeholder="John Doe"></div>
      <div class="field"><label>Patient ID</label><input class="inp" id="scan-pid" placeholder="PT-00123"></div>
    </div>
    <div class="fgrid">
      <div class="field"><label>Scan Type</label>
        <select class="inp" id="scan-type">
          <option value="mri">MRI Scan</option>
          <option value="xray">X-Ray</option>
          <option value="ct">CT Scan</option>
          <option value="ultrasound">Ultrasound</option>
          <option value="ecg">ECG / EKG</option>
          <option value="echo">Echocardiogram</option>
          <option value="pet">PET Scan</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field"><label>Body Region</label>
        <select class="inp" id="scan-region">
          <option>Brain / Head</option>
          <option>Chest / Thorax</option>
          <option>Abdomen</option>
          <option>Spine / Back</option>
          <option>Pelvis / Hip</option>
          <option>Knee / Leg</option>
          <option>Shoulder / Arm</option>
          <option>Full Body</option>
        </select>
      </div>
    </div>
    <div class="field"><label>Clinical Notes</label><textarea class="inp" id="scan-notes" rows="2" placeholder="Clinical indication, findings summary‚Ä¶" style="resize:none"></textarea></div>
    <div class="field"><label>Requesting Physician</label><input class="inp" id="scan-dr" placeholder="Dr. Name"></div>
    <button class="btn-p" onclick="saveScan()" style="width:100%;margin-top:4px">üíæ Save Scan Record</button>
    <div class="alert al-s" id="scan-ok" style="margin-top:10px"></div>
   </div>
   <div class="card">
    <h3 style="margin-bottom:14px">üóÇÔ∏è Filter Scans</h3>
    <div class="field"><label>Filter by Type</label>
      <select class="inp" id="scan-filter-type" onchange="renderScans()">
        <option value="">All Types</option>
        <option value="mri">MRI</option>
        <option value="xray">X-Ray</option>
        <option value="ct">CT Scan</option>
        <option value="ultrasound">Ultrasound</option>
        <option value="ecg">ECG</option>
      </select>
    </div>
    <div class="field"><label>Filter by Patient</label><input class="inp" id="scan-filter-patient" placeholder="Patient name‚Ä¶" oninput="renderScans()"></div>
    <div style="background:var(--surface3);border-radius:10px;padding:16px;margin-top:8px">
      <h4 style="font-size:13px;margin-bottom:10px;color:var(--text3)">Storage Stats</h4>
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <div><div style="font-size:20px;font-weight:800;color:var(--primary)" id="scan-count-total">0</div><div style="font-size:11px;color:var(--text3)">Total Scans</div></div>
        <div><div style="font-size:20px;font-weight:800;color:var(--accent)" id="scan-count-mri">0</div><div style="font-size:11px;color:var(--text3)">MRI</div></div>
        <div><div style="font-size:20px;font-weight:800;color:var(--secondary)" id="scan-count-xray">0</div><div style="font-size:11px;color:var(--text3)">X-Ray</div></div>
        <div><div style="font-size:20px;font-weight:800;color:var(--warn)" id="scan-count-ct">0</div><div style="font-size:11px;color:var(--text3)">CT</div></div>
      </div>
    </div>
   </div>
  </div>
  <div class="g3" id="scan-grid">
    <div class="card" style="text-align:center;padding:28px;grid-column:1/-1"><p class="muted" style="font-size:13px">No scans stored yet. Upload your first scan above!</p></div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RISK AI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-risk">
 <div class="container">
  <div class="page-header">
    <div class="pill">‚öïÔ∏è Predictive Clinical AI</div>
    <h2>Clinical <span style="color:var(--primary)">Risk Prediction</span></h2>
    <p class="muted">Modular, explainable risk scoring with urgency triage. Patients flagged as critical receive immediate action recommendations.</p>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px" id="risk-module-tabs">
    <button class="chip sel" onclick="switchRiskModule('single')">ü©∫ Single Patient</button>
    <button class="chip" onclick="switchRiskModule('batch')">üìã Batch Assessment</button>
    <button class="chip" onclick="switchRiskModule('urgent')">üö® Urgent Queue</button>
  </div>

  <div id="risk-single">
   <div class="g2">
    <div class="card">
      <h3 style="margin-bottom:16px">ü©∫ Patient Parameters</h3>
      <div class="fgrid">
        <div class="field"><label>Age (years)*</label><input class="inp" id="r-age" type="number" placeholder="52"></div>
        <div class="field"><label>Gender</label><select class="inp" id="r-gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
        <div class="field"><label>Systolic BP (mmHg)*</label><input class="inp" id="r-sbp" type="number" placeholder="140"></div>
        <div class="field"><label>Diastolic BP (mmHg)</label><input class="inp" id="r-dbp" type="number" placeholder="90"></div>
        <div class="field"><label>Blood Sugar (mg/dL)*</label><input class="inp" id="r-sugar" type="number" placeholder="126"></div>
        <div class="field"><label>BMI</label><input class="inp" id="r-bmi" type="number" step="0.1" placeholder="28.5"></div>
        <div class="field"><label>Cholesterol (mg/dL)</label><input class="inp" id="r-chol" type="number" placeholder="210"></div>
        <div class="field"><label>Smoking Status</label><select class="inp" id="r-smoke"><option value="">Select</option><option>Non-Smoker</option><option>Former Smoker</option><option>Current Smoker</option></select></div>
        <div class="field"><label>Heart Rate (bpm)</label><input class="inp" id="r-hr" type="number" placeholder="78"></div>
        <div class="field"><label>Family History CVD</label><select class="inp" id="r-fhx"><option value="no">No</option><option value="yes">Yes</option></select></div>
      </div>
      <div class="field"><label>Current Medications</label><input class="inp" id="r-meds" placeholder="e.g. Metformin, Lisinopril, Aspirin‚Ä¶"></div>
      <div class="field"><label>Chief Complaint / Symptoms</label><textarea class="inp" id="r-symptoms" rows="2" placeholder="e.g. chest pain, shortness of breath‚Ä¶" style="resize:none"></textarea></div>
      <button class="btn-p" onclick="predictRisk()" style="margin-top:12px;width:100%" id="risk-btn">‚ö° Predict Risk Level</button>
    </div>
    <div id="risk-panel">
      <div class="card" style="text-align:center;padding:52px 28px">
        <div style="font-size:52px;margin-bottom:14px">üî¨</div>
        <p class="muted" style="font-size:13px">Fill patient parameters and click Predict to see the AI risk assessment with explainable factors.</p>
      </div>
    </div>
   </div>
  </div>

  <div id="risk-batch" style="display:none">
   <div class="card">
    <h3 style="margin-bottom:14px">üìã Batch Patient Assessment</h3>
    <p class="muted" style="font-size:13px;margin-bottom:16px">Enter multiple patients for bulk risk triage. Patients with critical/high risk will be flagged for immediate action.</p>
    <div id="batch-patients">
      <div class="batch-row" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:10px">
        <div class="field" style="margin-bottom:0"><label>Patient Name</label><input class="inp" placeholder="Name" style="font-size:12px"></div>
        <div class="field" style="margin-bottom:0"><label>Age</label><input class="inp" type="number" placeholder="Age" style="font-size:12px"></div>
        <div class="field" style="margin-bottom:0"><label>Sys BP</label><input class="inp" type="number" placeholder="BP" style="font-size:12px"></div>
        <div class="field" style="margin-bottom:0"><label>Sugar</label><input class="inp" type="number" placeholder="Sugar" style="font-size:12px"></div>
        <div class="field" style="margin-bottom:0"><label>BMI</label><input class="inp" type="number" placeholder="BMI" style="font-size:12px"></div>
        <button class="btn-danger" onclick="this.parentElement.remove()" style="margin-bottom:0;padding:10px 12px">‚úï</button>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn-s" onclick="addBatchRow()" style="font-size:12px">+ Add Patient</button>
      <button class="btn-p" onclick="runBatchRisk()" style="font-size:12px">‚ö° Run Batch Assessment</button>
    </div>
    <div id="batch-results" style="margin-top:20px"></div>
   </div>
  </div>

  <div id="risk-urgent" style="display:none">
   <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3>üö® Urgent Patient Queue</h3>
      <span class="tag tg-r" id="urgent-count">0 Urgent</span>
    </div>
    <div class="alert al-w show" style="margin-bottom:14px;font-size:13px">‚ö†Ô∏è Patients with risk score ‚â• 70 or critical vital signs are automatically added to this queue.</div>
    <div id="urgent-queue">
      <p class="muted" style="text-align:center;padding:24px;font-size:13px">No urgent patients in queue. Run risk predictions to populate this queue.</p>
    </div>
   </div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-adr">
 <div class="container">
  <div class="page-header">
    <div class="pill">‚ö†Ô∏è EHR-Based Detection</div>
    <h2>Real-Time <span style="color:var(--primary)">ADR Detection System</span></h2>
    <p class="muted" style="max-width:580px">Adverse Drug Reaction detection using EHR data. Monitor drug interactions, flag patient-level risk, and track ADR history across your patient population.</p>
  </div>

  <div class="g2" style="margin-bottom:24px">
   <div class="card">
    <h3 style="margin-bottom:14px">üîç Check Drug Interactions</h3>
    <div class="field"><label>Primary Drug (Patient's Medication)</label><input class="inp" id="adr-drug1" placeholder="e.g. Warfarin, Metformin, Lisinopril‚Ä¶"></div>
    <div class="field"><label>Secondary Drug (New Prescription)</label><input class="inp" id="adr-drug2" placeholder="e.g. Aspirin, Ibuprofen‚Ä¶"></div>
    <div class="field"><label>Patient Age</label><input class="inp" id="adr-age" type="number" placeholder="e.g. 65"></div>
    <div class="field"><label>Relevant Conditions (optional)</label><input class="inp" id="adr-conditions" placeholder="e.g. CKD, Heart failure, Hepatic impairment‚Ä¶"></div>
    <button class="btn-p" onclick="checkADR()" style="width:100%;margin-top:8px" id="adr-btn">‚ö° Check ADR Risk</button>
    <div id="adr-result" style="margin-top:14px"></div>
   </div>
   <div>
    <div class="card" style="margin-bottom:14px">
      <h3 style="margin-bottom:12px">üìä ADR Summary</h3>
      <div class="g2" style="gap:10px">
        <div style="background:var(--danger-l);border:1px solid rgba(220,38,38,.2);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--danger)" id="adr-count-critical">0</div><div style="font-size:11px;color:var(--danger)">Critical ADRs</div></div>
        <div style="background:var(--warn-l);border:1px solid rgba(217,119,6,.2);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--warn)" id="adr-count-moderate">0</div><div style="font-size:11px;color:var(--warn)">Moderate ADRs</div></div>
        <div style="background:var(--primary-xl);border:1px solid rgba(37,99,235,.2);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--primary)" id="adr-count-minor">0</div><div style="font-size:11px;color:var(--primary)">Minor ADRs</div></div>
        <div style="background:var(--accent-l);border:1px solid rgba(5,150,105,.2);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--accent)" id="adr-count-safe">0</div><div style="font-size:11px;color:var(--accent)">Safe Combos</div></div>
      </div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:12px">‚ö†Ô∏è Known High-Risk Combos</h3>
      <div class="drug-combo-row"><span class="tag tg-r">CRITICAL</span><span style="font-size:13px;color:var(--text2)">Warfarin + Aspirin ‚Üí Bleeding risk</span></div>
      <div class="drug-combo-row"><span class="tag tg-r">HIGH</span><span style="font-size:13px;color:var(--text2)">MAOIs + SSRIs ‚Üí Serotonin syndrome</span></div>
      <div class="drug-combo-row"><span class="tag tg-y">MODERATE</span><span style="font-size:13px;color:var(--text2)">ACE inhibitors + K-sparing diuretics</span></div>
      <div class="drug-combo-row"><span class="tag tg-y">MODERATE</span><span style="font-size:13px;color:var(--text2)">Metformin + Contrast dye ‚Üí Lactic acidosis</span></div>
      <div class="drug-combo-row"><span class="tag tg-b">MINOR</span><span style="font-size:13px;color:var(--text2)">Statins + Grapefruit juice</span></div>
    </div>
   </div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:14px">üìã ADR Event Log</h3>
    <div class="g2" style="margin-bottom:16px">
      <div class="field" style="margin-bottom:0"><label>Report ADR Event</label><input class="inp" id="adr-report-drug" placeholder="Drug name causing reaction"></div>
      <div class="field" style="margin-bottom:0"><label>Patient ID</label><input class="inp" id="adr-report-pid" placeholder="PT-XXXXX"></div>
    </div>
    <div class="fgrid" style="margin-bottom:12px">
      <div class="field"><label>Reaction Description</label><input class="inp" id="adr-report-reaction" placeholder="e.g. Rash, hypotension, bleeding‚Ä¶"></div>
      <div class="field"><label>Severity</label><select class="inp" id="adr-report-severity"><option value="mild">Mild</option><option value="moderate">Moderate</option><option value="severe">Severe / Critical</option></select></div>
    </div>
    <button class="btn-p" onclick="reportADR()">üìù Log ADR Event</button>
    <div style="margin-top:16px;overflow-x:auto">
      <table id="adr-log-table">
        <thead><tr><th>Time</th><th>Drug</th><th>Patient</th><th>Reaction</th><th>Severity</th></tr></thead>
        <tbody id="adr-log-body"><tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No ADR events logged yet.</td></tr></tbody>
      </table>
    </div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-dashboard">
 <div class="container">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px">
   <div>
    <div class="pill">üìä Live Analytics</div>
    <h2>Real-Time <span style="color:var(--primary)">Dashboard</span></h2>
    <p class="muted" style="font-size:13px">Connected to <code>/api/dashboard</code></p>
   </div>
   <button class="btn-p" onclick="loadDashboard()" style="padding:10px 18px;font-size:13px">üîÑ Refresh</button>
  </div>
  <div class="g-stat" id="dash-stats" style="margin-bottom:22px">
    <div class="stat-card"><div class="spinner"></div></div>
  </div>
  <div class="g2" style="margin-bottom:22px">
    <div class="card">
      <h3 style="margin-bottom:16px">üìä Module Usage</h3>
      <div id="dash-bars" style="display:flex;align-items:flex-end;gap:12px;height:130px"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:16px">‚öïÔ∏è Risk Distribution</h3>
      <div id="dash-risk"></div>
    </div>
  </div>
  <div class="g2">
    <div class="card"><h3 style="margin-bottom:12px">üíä Recent Prescriptions</h3><table><thead><tr><th>Patient</th><th>Medication</th><th>Status</th></tr></thead><tbody id="dash-rx-rows"></tbody></table></div>
    <div class="card"><h3 style="margin-bottom:12px">üß† Chat Sessions</h3><table><thead><tr><th>Session</th><th>Topic</th><th>Duration</th></tr></thead><tbody id="dash-sess-rows"></tbody></table></div>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REPORTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="pg-report">
 <div class="container">
  <div class="page-header">
    <div class="pill">üìë Reports</div>
    <h2>Patient Activity <span style="color:var(--primary)">Reports</span></h2>
    <p class="muted">Generate and download comprehensive patient activity reports in multiple formats.</p>
  </div>
  <div class="g2" style="margin-bottom:24px">
   <div class="card">
    <h3 style="margin-bottom:14px">‚öôÔ∏è Report Configuration</h3>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;text-transform:none;letter-spacing:0"><input type="checkbox" id="rpt-rx" checked> Include Prescriptions</label>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;text-transform:none;letter-spacing:0"><input type="checkbox" id="rpt-risk" checked> Include Risk Predictions</label>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;text-transform:none;letter-spacing:0"><input type="checkbox" id="rpt-chat" checked> Include Chatbot Sessions</label>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;text-transform:none;letter-spacing:0"><input type="checkbox" id="rpt-adr" checked> Include ADR Events</label>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer;text-transform:none;letter-spacing:0"><input type="checkbox" id="rpt-scans" checked> Include Scan Records</label>
    </div>
    <div class="field"><label>Report Format</label>
      <select class="inp" id="rpt-format">
        <option value="txt">Plain Text (.txt)</option>
        <option value="json">JSON (.json)</option>
        <option value="csv">CSV Spreadsheet (.csv)</option>
        <option value="html">HTML Report (.html)</option>
      </select>
    </div>
    <div style="display:flex;gap:10px;margin-top:14px">
      <button class="btn-p" onclick="generateReport()" id="rpt-btn">üìÑ Generate Report</button>
      <button class="btn-s" onclick="previewReport()">üëÅÔ∏è Preview</button>
    </div>
    <div class="alert al-s" id="rpt-ok" style="margin-top:12px">‚úÖ Report generated and downloaded!</div>
   </div>
   <div class="card">
    <h3 style="margin-bottom:14px">üìä Platform Summary</h3>
    <div id="rpt-summary">
      <div class="spinner" style="display:block;margin:20px auto"></div>
    </div>
   </div>
  </div>
  <div class="card" id="rpt-preview-panel" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <h3>üëÅÔ∏è Report Preview</h3>
      <button class="btn-s" onclick="document.getElementById('rpt-preview-panel').style.display='none'" style="font-size:12px">‚úï Close</button>
    </div>
    <pre id="rpt-preview-content" style="max-height:420px;font-size:11px"></pre>
  </div>
 </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGOUT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="logout-modal">
  <div class="modal" style="max-width:360px;text-align:center">
    <div style="font-size:48px;margin-bottom:12px">üëã</div>
    <h3 style="margin-bottom:8px">Sign Out?</h3>
    <p class="muted" style="font-size:13px;margin-bottom:20px">You'll be returned to the login screen.</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn-p" onclick="doLogout()">Sign Out</button>
      <button class="btn-s" onclick="document.getElementById('logout-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCAN VIEWER MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="scan-viewer-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <h3 id="scan-modal-title">Scan Viewer</h3>
      <button class="modal-close" onclick="document.getElementById('scan-viewer-modal').classList.remove('open')">‚úï</button>
    </div>
    <div id="scan-modal-content"></div>
  </div>
</div>

<div class="modal-backdrop" id="rx-viewer-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <h3 id="rx-modal-title">Prescription Viewer</h3>
      <button class="modal-close" onclick="document.getElementById('rx-viewer-modal').classList.remove('open')">‚úï</button>
    </div>
    <div id="rx-modal-content"></div>
  </div>
</div>

<script>
async function showUserModal() {
  if (!currentUser) return;
  document.getElementById('user-modal-name').textContent = currentUser.name || '';
  document.getElementById('user-modal-email').textContent = currentUser.email || '';
  document.getElementById('user-modal').classList.add('open');
  
  try {
    const response = await apiFetch('/api/user/dashboard', { method: 'GET' });
    if (response && response.stats) {
      renderUserDashboard(response);
    }
  } catch (err) {
    console.error('Failed to load user dashboard:', err);
  }
}

function renderUserDashboard(data) {
  const statsDiv = document.getElementById('user-dashboard-stats');
  const activityDiv = document.getElementById('user-dashboard-activity');
  
  if (data.stats) {
    statsDiv.innerHTML = `
      <div style="background:linear-gradient(135deg,#dbeafe,#fef3c7);padding:16px;border-radius:8px;border-left:4px solid var(--primary)">
        <div style="font-size:24px;font-weight:bold;color:var(--primary)">${data.stats.prescriptions_uploaded}</div>
        <div style="font-size:12px;color:#666">Prescriptions Uploaded</div>
      </div>
      <div style="background:linear-gradient(135deg,#e0e7ff,#c7d2fe);padding:16px;border-radius:8px;border-left:4px solid #7c3aed">
        <div style="font-size:24px;font-weight:bold;color:#7c3aed">${data.stats.scans_uploaded}</div>
        <div style="font-size:12px;color:#666">Scans Uploaded</div>
      </div>
      <div style="background:linear-gradient(135deg,#fee2e2,#fecaca);padding:16px;border-radius:8px;border-left:4px solid var(--danger)">
        <div style="font-size:24px;font-weight:bold;color:var(--danger)">${data.stats.adr_reports}</div>
        <div style="font-size:12px;color:#666">ADR Reports</div>
      </div>
      <div style="background:linear-gradient(135deg,#d1fae5,#a7f3d0);padding:16px;border-radius:8px;border-left:4px solid var(--accent)">
        <div style="font-size:24px;font-weight:bold;color:var(--accent)">${data.stats.risk_predictions}</div>
        <div style="font-size:12px;color:#666">Risk Assessments</div>
      </div>
      <div style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:16px;border-radius:8px;border-left:4px solid #ec4899">
        <div style="font-size:24px;font-weight:bold;color:#ec4899">${data.stats.chat_sessions}</div>
        <div style="font-size:12px;color:#666">Wellness Sessions</div>
      </div>
      <div style="background:linear-gradient(135deg,#f3e8ff,#e9d5ff);padding:16px;border-radius:8px;border-left:4px solid var(--purple)">
        <div style="font-size:24px;font-weight:bold;color:var(--purple)">${data.stats.total_actions}</div>
        <div style="font-size:12px;color:#666">Total Activities</div>
      </div>
    `;
  }
  
  let activityHTML = '<div style="margin-top:20px"><h3 style="margin-bottom:12px">üìã Complete Activity History</h3>';
  
  let hasActivity = false;
  
  if (data.activity.prescriptions && data.activity.prescriptions.length > 0) {
    hasActivity = true;
    activityHTML += '<div style="margin-bottom:16px"><h4 style="color:var(--primary);margin-bottom:8px">üíä Prescriptions (' + data.activity.prescriptions.length + ')</h4>';
    data.activity.prescriptions.forEach(p => {
      const med = p.fhir?.medicationCodeableConcept?.coding?.[0]?.display || 'Unknown Medication';
      activityHTML += `<div style="background:#f8fafc;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px">
        <strong>${med}</strong><br>
        <span style="color:#999">${new Date(p.timestamp).toLocaleDateString()}</span>
      </div>`;
    });
    activityHTML += '</div>';
  }
  
  if (data.activity.scans && data.activity.scans.length > 0) {
    hasActivity = true;
    activityHTML += '<div style="margin-bottom:16px"><h4 style="color:#7c3aed;margin-bottom:8px">üñºÔ∏è Scans (' + data.activity.scans.length + ')</h4>';
    data.activity.scans.forEach(s => {
      activityHTML += `<div style="background:#f8fafc;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px">
        <strong>${s.type.toUpperCase()}</strong> - ${s.region}<br>
        <span style="color:#999">${new Date(s.date).toLocaleDateString()} | ${s.filename}</span>
      </div>`;
    });
    activityHTML += '</div>';
  }
  
  if (data.activity.adr_reports && data.activity.adr_reports.length > 0) {
    hasActivity = true;
    activityHTML += '<div style="margin-bottom:16px"><h4 style="color:var(--danger);margin-bottom:8px">‚ö†Ô∏è ADR Reports (' + data.activity.adr_reports.length + ')</h4>';
    data.activity.adr_reports.forEach(a => {
      const severity_color = a.severity === 'critical' ? 'var(--danger)' : a.severity === 'moderate' ? 'var(--warn)' : '#059669';
      activityHTML += `<div style="background:#f8fafc;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px;border-left:3px solid ${severity_color}">
        <strong style="color:${severity_color}">${a.severity.toUpperCase()}</strong> - ${a.medication}<br>
        <span style="color:#999">${new Date(a.timestamp).toLocaleDateString()}</span>
      </div>`;
    });
    activityHTML += '</div>';
  }
  
  if (data.activity.risk_predictions && data.activity.risk_predictions.length > 0) {
    hasActivity = true;
    activityHTML += '<div style="margin-bottom:16px"><h4 style="color:var(--accent);margin-bottom:8px">‚öïÔ∏è Risk Assessments (' + data.activity.risk_predictions.length + ')</h4>';
    data.activity.risk_predictions.forEach(r => {
      const level_color = r.result?.risk_level === 'High' ? 'var(--danger)' : r.result?.risk_level === 'Medium' ? 'var(--warn)' : 'var(--accent)';
      activityHTML += `<div style="background:#f8fafc;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px">
        <strong style="color:${level_color}">Risk: ${r.result?.risk_level || 'Unknown'}</strong><br>
        <span style="color:#999">Score: ${r.result?.score || '0'}/100 | ${new Date(r.timestamp).toLocaleDateString()}</span>
      </div>`;
    });
    activityHTML += '</div>';
  }
  
  if (data.activity.chat_sessions && data.activity.chat_sessions.length > 0) {
    hasActivity = true;
    activityHTML += '<div style="margin-bottom:16px"><h4 style="color:#ec4899;margin-bottom:8px">üí¨ Wellness Sessions (' + data.activity.chat_sessions.length + ')</h4>';
    data.activity.chat_sessions.forEach(s => {
      activityHTML += `<div style="background:#f8fafc;padding:8px;border-radius:6px;margin-bottom:6px;font-size:13px">
        <strong>${s.topic || 'Wellness Chat'}</strong><br>
        <span style="color:#999">${new Date(s.timestamp).toLocaleDateString()} | ${s.duration_min || '0'} min</span>
      </div>`;
    });
    activityHTML += '</div>';
  }
  
  if (!hasActivity) {
    activityHTML += '<div style="color:#999;text-align:center;padding:20px">No activity recorded yet. Start by uploading prescriptions, scans, or using wellness features.</div>';
  }
  
  activityHTML += '</div>';
  activityDiv.innerHTML = activityHTML;
}

function closeUserModal() {
  document.getElementById('user-modal').classList.remove('open');
}

// Replace nav-user click handler to show user modal
document.addEventListener('DOMContentLoaded', function() {
  const navUser = document.querySelector('.nav-user');
  if (navUser) navUser.onclick = showUserModal;
});
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = window.location.protocol === 'file:' ? 'http://localhost:8000' : window.location.origin;
let currentUser = null;
const scanDB = [];
const adrLog = [];
const moodLog = [];
const urgentQueue = [];
let lastRxFhir = null;
let lastRxPatient = '';
let adrCounts = {critical:0,moderate:0,minor:0,safe:0};

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const email = document.getElementById('l-email').value.trim();
  const pass = document.getElementById('l-pass').value;
  if (!email || !pass) { showLoginErr('Please enter your email and password.'); return; }
  const btn = document.querySelector('#login-form-section .btn-login');
  const orig = btn.textContent;
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Signing in‚Ä¶';
  try {
    const res = await fetch(API + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Invalid email or password');
    if (data.token) localStorage.setItem('medisync_token', data.token);
    loginSuccess(data.user.name, data.user.email, data.user.role);
  } catch (err) {
    console.error('Login error:', err);
    showLoginErr(err.message === 'Failed to fetch' ? 'Cannot connect to API server. Ensure "python main.py" is running.' : err.message);
    btn.disabled = false; btn.textContent = orig;
  }
}

async function doRegister() {
  const name = document.getElementById('r-name').value.trim();
  const email = document.getElementById('r-email').value.trim();
  const pass = document.getElementById('r-pass').value;
  const role = document.getElementById('r-role').value;
  if (!name || !email || !pass) { showLoginErr('Please fill in all fields.'); return; }
  if (pass.length < 8) { showLoginErr('Password must be at least 8 characters.'); return; }
  const btn = document.querySelector('#register-form-section .btn-login');
  const orig = btn.textContent;
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Creating account‚Ä¶';
  try {
    const res = await fetch(API + '/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password: pass, role })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Registration failed');
    if (data.token) localStorage.setItem('medisync_token', data.token);
    loginSuccess(data.user.name, data.user.email, data.user.role);
  } catch (err) {
    console.error('Registration error:', err);
    showLoginErr(err.message === 'Failed to fetch' ? 'Cannot connect to API server. Ensure "python main.py" is running.' : err.message);
    btn.disabled = false; btn.textContent = orig;
  }
}

function loginSuccess(name, email, role, picture) {
  currentUser = { name, email, role, picture };
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-nav').style.display = 'flex';
  const av = document.getElementById('nav-av-initials');
  const initials = name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0, 2);
  if (picture) {
    const img = document.createElement('img');
    img.src = picture;
    img.style.cssText = 'width:28px;height:28px;border-radius:50%;object-fit:cover';
    img.onerror = function(){ av.textContent = initials; };
    av.innerHTML = '';
    av.appendChild(img);
  } else {
    av.textContent = initials;
  }
  document.getElementById('nav-username').textContent = name.split(' ')[0];
  go('home');
  checkAPI();
  setInterval(checkAPI, 12000);
  loadDashStats();
}

function showLoginErr(msg) {
  const el = document.getElementById('login-err');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function toggleRegister() {
  const login = document.getElementById('login-form-section');
  const reg = document.getElementById('register-form-section');
  const err = document.getElementById('login-err');
  err.style.display = 'none';
  if (login.style.display === 'none') { login.style.display = 'block'; reg.style.display = 'none'; }
  else { login.style.display = 'none'; reg.style.display = 'block'; }
}

function showLogout() { document.getElementById('logout-modal').classList.add('open'); }

function doLogout() {
  currentUser = null;
  document.getElementById('logout-modal').classList.remove('open');
  document.getElementById('main-nav').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('l-email').value = '';
  document.getElementById('l-pass').value = '';
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const el = document.getElementById('pg-' + page);
  const btn = document.getElementById('nb-' + page);
  if (el) {
    el.classList.add('active');
    el.style.display = 'block';
  }
  // Hide all other pages
  document.querySelectorAll('.page').forEach(p => {
    if (p !== el) p.style.display = 'none';
  });
  if (btn) btn.classList.add('active');
  window.scrollTo(0, 0);
  if (page === 'dashboard') loadDashboard();
  if (page === 'report') loadReportSummary();
  if (page === 'rx') loadPrescriptions();
  if (page === 'scans') renderScans();
  if (page === 'risk') renderUrgentQueue();
}

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiFetch(path, opts = {}) {
  try {
    const token = localStorage.getItem('medisync_token');
    opts.headers = {
      ...(opts.headers || {}),
      'Content-Type': 'application/json'
    };
    if (token) {
      opts.headers['Authorization'] = 'Bearer ' + token;
    }
    const r = await fetch(API + path, opts);
    if (!r.ok) {
      console.error(`API Error [${path}]: ${r.status} ${r.statusText}`);
      return null;
    }
    return await r.json();
  } catch (err) {
    console.error(`Fetch Error [${path}]:`, err);
    return null;
  }
}

async function checkAPI() {
  const data = await apiFetch('/api/health');
  const online = !!data;
  const badge = document.getElementById('api-badge');
  const dot = document.getElementById('api-dot');
  const txt = document.getElementById('api-txt');
  if (badge) {
    badge.className = 'api-badge ' + (online ? 'api-on' : 'api-off');
    dot.className = 'dot ' + (online ? 'dot-g' : 'dot-r');
    txt.textContent = online ? 'API Online ‚Äî FastAPI Connected' : 'API Offline ‚Äî Demo mode active';
  }
}

async function loadDashStats() {
  const data = await apiFetch('/api/dashboard');
  if (data?.stats) {
    setEl('h-stat1', data.stats.prescriptions_processed);
    setEl('h-stat2', data.stats.risk_predictions);
    setEl('h-stat3', data.stats.chatbot_sessions);
  }
  setEl('h-stat4', adrLog.filter(a => a.severity === 'severe').length);
}

function setEl(id, val) { const e = document.getElementById(id); if (e) e.textContent = val ?? '‚Äî'; }

// ‚îÄ‚îÄ‚îÄ WELLNESS CHATBOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const wellnessResponses = {
  keywords: {
    'anxious|anxiety|panic|worried|worry|nervous': [
      "I hear you ‚Äî anxiety can feel really overwhelming. üíô Let's take a breath together.\n\nTry 4-7-8 breathing: **Inhale for 4 counts ‚Üí Hold for 7 ‚Üí Exhale for 8**.\n\nWould you like me to guide you through a full breathing exercise, or would you prefer to explore what's triggering your anxiety using a CBT thought record?",
      "Anxiety is one of the most common things people experience ‚Äî you're not alone. üåø\n\nA technique I find helpful is grounding: Name 5 things you can see, 4 you can touch, 3 you hear. This anchors you to the present moment.\n\nWould you like to talk about what's been making you feel this way?"
    ],
    'depress|sad|hopeless|empty|numb|low mood|down': [
      "I'm really glad you're sharing this with me. Feeling low or depressed is heavy, and it matters. üíô\n\nCBT research shows that gently challenging negative thought patterns can help. Can you tell me one thought that keeps coming back to you when you feel this way? We can look at it together.\n\nPlease remember: if these feelings are severe or persistent, speaking to a mental health professional can make a real difference.",
      "Thank you for trusting me with how you're feeling. Depression lies ‚Äî it tells us things won't improve, but that's not the full picture. üå±\n\nSmall steps matter: a 10-minute walk, connecting with one person today, or one small act of self-care.\n\nWould you like to try a gratitude journaling exercise? Even 3 small things can shift our perspective."
    ],
    'sleep|insomnia|tired|exhausted|cant sleep': [
      "Poor sleep can really affect how we feel emotionally and physically. üò¥\n\nSome evidence-based sleep hygiene tips:\n‚Ä¢ Keep a consistent sleep/wake schedule even on weekends\n‚Ä¢ Avoid screens 1 hour before bed ‚Äî the blue light suppresses melatonin\n‚Ä¢ Keep your bedroom cool (18‚Äì20¬∞C) and dark\n‚Ä¢ Try the 4-7-8 breathing technique to fall asleep\n\nHow long has this been going on? Any particular thoughts keeping you awake?"
    ],
    'stress|overwhelmed|burnout|too much|pressure': [
      "That sounds really heavy ‚Äî being overwhelmed can feel like carrying too much at once. üåä\n\nLet's try to break this down. Often stress feels worse when we see it as one giant problem rather than smaller manageable parts.\n\nCan you tell me the top 3 things that feel most overwhelming right now? Sometimes just naming them helps."
    ],
    'lonely|alone|isolated|no one|nobody': [
      "Loneliness is one of the most painful human experiences. You reaching out right now ‚Äî even to me ‚Äî shows real courage. üíô\n\nConnecting with others is one of the strongest predictors of wellbeing. Even small steps help: texting one person today, joining a community group, or volunteering.\n\nIs there someone in your life you've been meaning to reach out to but haven't?"
    ],
    'suicid|self harm|kill myself|end it all|hurt myself': [
      "üÜò I'm really concerned about what you've shared. Please know that you matter deeply.\n\nRight now, please reach out to a crisis line:\n‚Ä¢ **988 Suicide & Crisis Lifeline** (US) ‚Äî call or text 988\n‚Ä¢ **Crisis Text Line** ‚Äî text HOME to 741741\n‚Ä¢ **International Association for Suicide Prevention** ‚Äî https://www.iasp.info/resources/Crisis_Centres/\n\nIf you're in immediate danger, please call emergency services (911/999) now.\n\nI'm here with you. Would you like to talk about what's brought you to this point?"
    ]
  },
  default: [
    "Thank you for sharing that with me. üåø I'm here to listen and support you.\n\nUsing CBT principles, let's explore what you're experiencing. How has this been affecting your daily life ‚Äî your sleep, your relationships, your work?",
    "That sounds really challenging. Mental health journeys aren't linear, and every feeling you have is valid. üíô\n\nI'm an AI companion inspired by Woebot and Wysa ‚Äî I can offer evidence-based support, mood tracking, and guided exercises. For ongoing mental health support, I'd also encourage connecting with a licensed therapist.\n\nWhat would be most helpful for you right now ‚Äî to talk, to try a calming exercise, or to understand what you're feeling better?"
  ]
};

function matchWellness(msg) {
  const m = msg.toLowerCase();
  for (const [pattern, responses] of Object.entries(wellnessResponses.keywords)) {
    if (new RegExp(pattern).test(m)) {
      return responses[Math.floor(Math.random() * responses.length)];
    }
  }
  return wellnessResponses.default[Math.floor(Math.random() * wellnessResponses.default.length)];
}

async function sendWellness() {
  const inp = document.getElementById('well-inp');
  const msg = inp.value.trim();
  if (!msg) return;
  inp.value = '';
  addMsg('well-msgs', msg, 'user');
  const typing = addTyping('well-msgs');

  // Try API first, fall back to local
  const data = await apiFetch('/api/mental-health', { method: 'POST', body: JSON.stringify({ message: msg }) });
  typing.remove();
  const reply = data?.response || matchWellness(msg);
  addMsg('well-msgs', reply, 'bot');
}

function wellQuick(msg) { document.getElementById('well-inp').value = msg; sendWellness(); }

let chatHistory = [];
let currentSessionId = null;

async function showHistoryPanel() {
  const modal = document.getElementById('history-modal');
  modal.style.display = 'flex';
  await loadChatHistory();
}

function closeHistoryPanel() {
  const modal = document.getElementById('history-modal');
  modal.style.display = 'none';
}

async function loadChatHistory() {
  const listEl = document.getElementById('history-list');
  try {
    const sessions = await apiFetch('/api/wellness/sessions');
    if (!sessions || sessions.length === 0) {
      listEl.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3)"><p>No chat history yet.</p><p style="font-size:12px;margin-top:8px">Start a conversation with MindCare AI to create sessions.</p></div>';
      return;
    }
    
    listEl.innerHTML = sessions.map(session => {
      const date = new Date(session.timestamp);
      const timeStr = date.toLocaleString();
      const preview = session.message_preview || session.messages?.[0]?.content || 'No content';
      return `
        <div class="card card-sm" style="cursor:pointer;transition:all .2s;border:1px solid var(--border)" onclick="loadSessionConversation('${session.id}')">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <span style="font-weight:600;font-size:13px;color:var(--primary)">üìå ${session.id}</span>
            <span style="font-size:11px;color:var(--text4)">${timeStr}</span>
          </div>
          <p style="font-size:12px;color:var(--text2);margin-bottom:6px;line-height:1.4">${preview.substring(0, 100)}${preview.length > 100 ? '...' : ''}</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag tg-b" style="font-size:10px">${session.topic || 'Wellness Chat'}</span>
            ${session.messages ? `<span class="tag tg-g" style="font-size:10px">${session.messages.length} messages</span>` : ''}
          </div>
        </div>`;
    }).join('');
  } catch (err) {
    console.error('Failed to load chat history:', err);
    listEl.innerHTML = '<div style="color:var(--danger);text-align:center;padding:20px">Failed to load history. Please try again.</div>';
  }
}

async function loadSessionConversation(sessionId) {
  try {
    const session = await apiFetch(`/api/wellness/sessions/${sessionId}`);
    if (!session) {
      alert('Session not found.');
      return;
    }
    
    currentSessionId = sessionId;
    const msgsContainer = document.getElementById('well-msgs');
    msgsContainer.innerHTML = '';
    
    if (session.messages && session.messages.length > 0) {
      session.messages.forEach(msg => {
        addMsg('well-msgs', msg.content, msg.type);
      });
    } else {
      msgsContainer.innerHTML = '<div class="msg bot"><div class="msg-av">üåø</div><div class="bubble">This session has no messages stored.</div></div>';
    }
    
    closeHistoryPanel();
  } catch (err) {
    console.error('Failed to load session:', err);
    alert('Failed to load session. Please try again.');
  }
}

function addMsg(container, text, type) {
  const msgs = document.getElementById(container);
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  const avIcon = type === 'bot' ? 'üåø' : 'üë§';
  div.innerHTML = `<div class="msg-av">${avIcon}</div><div class="bubble">${text.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

// ‚îÄ‚îÄ‚îÄ COMPREHENSIVE HISTORY FEATURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allHistoryData = [];
let currentHistoryFilter = 'all';

async function showAllHistory() {
  document.getElementById('all-history-modal').style.display = 'flex';
  const data = await apiFetch('/api/user/history');
  allHistoryData = data || [];
  renderAllHistory();
}

function filterHistory(type) {
  currentHistoryFilter = type;
  // Update filter button states
  document.querySelectorAll('#history-filters .chip').forEach(btn => {
    btn.classList.remove('sel');
  });
  event.target.classList.add('sel');
  renderAllHistory();
}

function renderAllHistory() {
  const el = document.getElementById('all-history-list');
  
  if (!allHistoryData || allHistoryData.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:32px;color:var(--text3)"><div style="font-size:40px;margin-bottom:12px">üìã</div><p>No activity history yet.</p><p style="font-size:12px;margin-top:8px">Your actions will appear here as you use the platform.</p></div>';
    return;
  }
  
  // Filter data
  const filtered = currentHistoryFilter === 'all' 
    ? allHistoryData 
    : allHistoryData.filter(h => h.type === currentHistoryFilter);
  
  if (filtered.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3)">No activities of this type yet.</div>';
    return;
  }
  
  el.innerHTML = filtered.map(item => {
    const date = new Date(item.timestamp);
    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const isClickable = item.type === 'wellness_chat';
    const cursorStyle = isClickable ? 'cursor:pointer' : '';
    const hoverEffect = isClickable ? `onmouseover="this.style.borderColor='var(--primary)';this.style.background='var(--primary-xl)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface)'"` : '';
    const clickHandler = isClickable ? `onclick="loadChatSessionFromHistory('${item.ref_id}')"` : '';
    
    return `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;transition:.2s;${cursorStyle}" 
           ${hoverEffect} ${clickHandler}>
        <div style="display:flex;align-items:start;gap:10px">
          <div style="font-size:24px;line-height:1">${item.icon}</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px">${item.title}</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px;overflow:hidden;text-overflow:ellipsis">${item.summary}</div>
            <div style="font-size:11px;color:var(--text4)">${dateStr}</div>
          </div>
          ${isClickable ? '<div style="color:var(--primary);font-size:11px;font-weight:600">Click to view ‚Üí</div>' : ''}
        </div>
      </div>
    `;
  }).join('');
}

function closeAllHistory() {
  document.getElementById('all-history-modal').style.display = 'none';
}

async function loadChatSessionFromHistory(sessionId) {
  // Close history modal
  closeAllHistory();
  
  // Switch to wellness chat tab
  go('mental');
  switchWTab('chat');
  
  // Fetch full session details
  const data = await apiFetch(`/api/wellness/sessions/${sessionId}`);
  if (!data) {
    alert('Could not load chat session.');
    return;
  }
  
  // Clear current messages
  const msgContainer = document.getElementById('well-msgs');
  msgContainer.innerHTML = '';
  
  // Render all messages from the session
  if (data.messages && data.messages.length > 0) {
    data.messages.forEach(msg => {
      const msgType = msg.type === 'user' ? 'user' : 'bot';
      addMsg('well-msgs', msg.content, msgType);
    });
  } else {
    // Fallback if no messages array exists
    addMsg('well-msgs', 'This is a restored chat session.', 'bot');
    if (data.message_preview) {
      addMsg('well-msgs', data.message_preview, 'user');
    }
  }
  
  // Scroll to bottom
  msgContainer.scrollTop = msgContainer.scrollHeight;
  
  // Show notification
  addMsg('well-msgs', 'üìú Chat session restored from history. Continue the conversation below.', 'bot');
}

function addTyping(container) {
  const msgs = document.getElementById(container);
  const div = document.createElement('div');
  div.className = 'msg bot';
  div.innerHTML = `<div class="msg-av">üåø</div><div class="bubble typing"><span></span><span></span><span></span></div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

// ‚îÄ‚îÄ WELLNESS TABS ‚îÄ‚îÄ
function switchWTab(tab) {
  document.querySelectorAll('.wtab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.wtab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.wtab-btn[onclick="switchWTab('${tab}')"]`).classList.add('active');
  document.getElementById('wt-' + tab).classList.add('active');
}

function switchDocTab(tab) {
  const container = document.getElementById('pg-docs');
  container.querySelectorAll('.wtab-btn').forEach(b => b.classList.remove('active'));
  container.querySelectorAll('.doc-tab-content').forEach(c => c.classList.remove('active'));
  container.querySelector(`.wtab-btn[onclick="switchDocTab('${tab}')"]`).classList.add('active');
  document.getElementById('dt-' + tab).classList.add('active');
}

// ‚îÄ‚îÄ MOOD TRACKER ‚îÄ‚îÄ
function saveMoodEntry() {
  const entry = {
    date: new Date().toLocaleString(),
    mood: document.getElementById('mood-overall').value,
    anxiety: document.getElementById('mood-anx').value,
    energy: document.getElementById('mood-energy').value,
    sleep: document.getElementById('mood-sleep').value,
    notes: document.getElementById('mood-notes').value
  };
  moodLog.unshift(entry);
  renderMoodHistory();
}

function renderMoodHistory() {
  const el = document.getElementById('mood-history-list');
  if (!moodLog.length) { el.innerHTML = '<p class="muted" style="text-align:center;padding:24px;font-size:13px">No entries yet.</p>'; return; }
  el.innerHTML = moodLog.slice(0, 10).map(e => `
    <div style="padding:12px;background:var(--surface2);border-radius:10px;margin-bottom:8px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;color:var(--text3)">${e.date}</span><span class="tag tg-b">Mood ${e.mood}/10</span></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <span style="font-size:12px;color:var(--warn)">Anxiety ${e.anxiety}/10</span>
        <span style="font-size:12px;color:var(--accent)">Energy ${e.energy}/10</span>
        <span style="font-size:12px;color:var(--secondary)">Sleep ${e.sleep}/10</span>
      </div>
      ${e.notes ? `<p style="font-size:12px;color:var(--text3);margin-top:5px">${e.notes}</p>` : ''}
    </div>`).join('');
}

// ‚îÄ‚îÄ BREATHING ‚îÄ‚îÄ
let breathInterval = null;
let breathRunning = false;
function startBreathing() {
  if (breathRunning) { clearInterval(breathInterval); breathRunning = false; document.getElementById('breath-btn').textContent = '‚ñ∂ Start Exercise'; document.getElementById('breathing-timer').textContent = '4'; document.getElementById('breathing-label').textContent = 'Press Start to begin'; return; }
  breathRunning = true;
  document.getElementById('breath-btn').textContent = '‚èπ Stop';
  const phases = [{n:4,l:'Inhale...'},{n:7,l:'Hold...'},{n:8,l:'Exhale...'}];
  let pi = 0, count = phases[0].n;
  const update = () => {
    document.getElementById('breathing-timer').textContent = count;
    document.getElementById('breathing-label').textContent = phases[pi].l;
    count--;
    if (count < 0) { pi = (pi + 1) % 3; count = phases[pi].n; }
  };
  update();
  breathInterval = setInterval(update, 1000);
}

// ‚îÄ‚îÄ CBT ANALYZER ‚îÄ‚îÄ
function analyzeCBT() {
  const sit = document.getElementById('cbt-sit').value;
  const thought = document.getElementById('cbt-thought').value;
  const emotion = document.getElementById('cbt-emotion').value;
  if (!thought) { alert('Please enter the automatic thought.'); return; }
  const panel = document.getElementById('risk-panel');
  // Show CBT analysis in wellness chat
  const reply = `üß© **CBT Thought Analysis**\n\nSituation: "${sit}"\nThought: "${thought}"\nEmotion: "${emotion}"\n\nThis appears to be a cognitive distortion pattern. Let's challenge it:\n\n**1. Is this thought based on facts or assumptions?**\n**2. What would you tell a friend thinking this?**\n**3. What's the most balanced view?**\n\nReframing: Instead of the original thought, consider a more balanced perspective that acknowledges both the challenge AND your ability to cope.`;
  switchWTab('chat');
  addMsg('well-msgs', reply, 'bot');
}

function saveGratitude() {
  const text = document.getElementById('gratitude-text').value.trim();
  if (!text) return;
  const ok = document.getElementById('gratitude-ok');
  ok.textContent = '‚úÖ Gratitude entry saved! Research shows this boosts wellbeing over time.';
  ok.classList.add('show');
  setTimeout(() => ok.classList.remove('show'), 3000);
  document.getElementById('gratitude-text').value = '';
}

// ‚îÄ‚îÄ‚îÄ RAG SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ragKB = {
  'diabetes': {
    answer: 'First-line treatment for Type 2 Diabetes Mellitus is lifestyle intervention (diet, exercise, weight management) combined with Metformin, unless contraindicated. ADA 2024 guidelines recommend HbA1c < 7% for most adults. For patients with established cardiovascular disease or CKD, GLP-1 receptor agonists (semaglutide, liraglutide) or SGLT-2 inhibitors (empagliflozin, dapagliflozin) are preferred add-on therapies due to their cardiorenal protective effects.',
    sources: [
      {title:'ADA Standards of Care in Diabetes 2024', url:'https://diabetesjournals.org/care/issue/47/Supplement_1', org:'American Diabetes Association'},
      {title:'WHO Diabetes Treatment Guidelines 2023', url:'https://www.who.int/news-room/fact-sheets/detail/diabetes', org:'WHO'},
      {title:'NICE NG28: Type 2 Diabetes in Adults Management', url:'https://www.nice.org.uk/guidance/ng28', org:'NICE UK'}
    ]
  },
  'hypertens': {
    answer: 'Hypertensive crisis (BP ‚â• 180/120 mmHg) may present with severe headache, visual disturbances, chest pain, or neurological symptoms. A hypertensive emergency involves acute end-organ damage requiring immediate IV antihypertensives in ICU. Hypertensive urgency (no organ damage) can be managed orally over 24‚Äì48 hours. First-line medications include ACE inhibitors, ARBs, calcium channel blockers, and thiazide diuretics.',
    sources: [
      {title:'ACC/AHA 2023 Hypertension Guidelines', url:'https://www.acc.org/guidelines', org:'ACC/AHA'},
      {title:'ESC/ESH Guidelines for Arterial Hypertension 2023', url:'https://www.escardio.org/Guidelines/Clinical-Practice-Guidelines/Arterial-Hypertension-Management-of', org:'ESC/ESH'},
      {title:'JNC 8: Evidence-Based Blood Pressure Guidelines', url:'https://jamanetwork.com/journals/jama/fullarticle/1791497', org:'JAMA'}
    ]
  },
  'cardiovascular|cardiac|heart': {
    answer: 'WHO and major cardiac societies recommend ‚â• 150 minutes/week moderate-intensity aerobic activity or ‚â• 75 minutes vigorous intensity for cardiovascular health. Maintain BMI 18.5‚Äì24.9, reduce sodium to < 2g/day, follow Mediterranean or DASH diet, avoid tobacco, limit alcohol. Monitor BP, LDL < 100 mg/dL for high-risk patients, and fasting glucose regularly.',
    sources: [
      {title:'ACC/AHA Primary Prevention of Cardiovascular Disease 2019', url:'https://www.ahajournals.org/doi/10.1161/CIR.0000000000000678', org:'AHA'},
      {title:'WHO Global Action Plan Prevention NCDs 2013‚Äì2020', url:'https://www.who.int/publications/i/item/9789241506236', org:'WHO'},
      {title:'AHA Heart Disease and Stroke Statistics 2024', url:'https://www.ahajournals.org/doi/10.1161/CIR.0000000000001209', org:'AHA'}
    ]
  },
  'anxiety|anxious': {
    answer: 'Generalised Anxiety Disorder (GAD) is best managed through stepped-care. First-line: Cognitive Behavioural Therapy (CBT). Pharmacotherapy: SSRIs (sertraline, escitalopram) or SNRIs (venlafaxine, duloxetine). NICE (CG113) recommends starting with low-intensity interventions (psychoeducation, self-help) before stepping up to high-intensity CBT or medication. Avoid long-term benzodiazepine use.',
    sources: [
      {title:'NICE CG113: Generalised Anxiety Disorder in Adults', url:'https://www.nice.org.uk/guidance/cg113', org:'NICE UK'},
      {title:'APA Practice Guidelines for GAD', url:'https://www.apa.org/practice/guidelines', org:'American Psychiatric Association'},
      {title:'WHO Mental Health Action Plan 2013‚Äì2030', url:'https://www.who.int/publications/i/item/9789240031029', org:'WHO'}
    ]
  },
  'asthma': {
    answer: 'GINA 2023 stepwise approach: Step 1 ‚Äî as-needed low-dose ICS-formoterol (preferred over SABA alone). Steps 2‚Äì5 ‚Äî escalate ICS dose, add LABA, consider biologics (dupilumab, mepolizumab) for severe eosinophilic asthma. Regular monitoring of ACQ/ACT scores. Trigger avoidance (allergens, smoke, exercise) is foundational.',
    sources: [
      {title:'GINA Global Strategy for Asthma Management 2023', url:'https://ginasthma.org/2023-gina-report-global-strategy-for-asthma-management-and-prevention/', org:'GINA'},
      {title:'BTS/SIGN British Asthma Guideline 2023', url:'https://www.brit-thoracic.org.uk/quality-improvement/guidelines/asthma/', org:'BTS/SIGN'},
      {title:'NICE NG80: Asthma Diagnosis and Monitoring', url:'https://www.nice.org.uk/guidance/ng80', org:'NICE UK'}
    ]
  },
  'sepsis': {
    answer: 'Sepsis-3 definition: life-threatening organ dysfunction caused by dysregulated host response to infection (SOFA score ‚â• 2). Surviving Sepsis Campaign 1-hour bundle: blood cultures before antibiotics, broad-spectrum antibiotics within 1 hour, 30mL/kg IV crystalloid if hypotensive, vasopressors if MAP < 65 mmHg, lactate measurement. Septic shock = vasopressor + lactate > 2 mmol/L despite adequate fluid resuscitation.',
    sources: [
      {title:'Surviving Sepsis Campaign Guidelines 2021', url:'https://www.sccm.org/SurvivingSepsisCampaign/Guidelines', org:'SCCM/ESICM'},
      {title:'Sepsis-3 Definition 2016 ‚Äî JAMA', url:'https://jamanetwork.com/journals/jama/fullarticle/2492881', org:'JAMA'},
      {title:'WHO Sepsis Technical Report 2020', url:'https://www.who.int/publications/i/item/9789240010789', org:'WHO'}
    ]
  },
  'myocardial|heart attack|ami|stemi|nstemi': {
    answer: 'Acute STEMI management: Reperfusion therapy within 120 min (primary PCI preferred). Fibrinolysis if PCI unavailable within 120 min. Antiplatelets: aspirin 300mg + P2Y12 inhibitor (ticagrelor or prasugrel). Anticoagulation: heparin or bivalirudin. NSTEMI/UA: risk stratify with GRACE score; early invasive strategy (< 24h) for high-risk. Discharge medications: DAPT, statin (high-intensity), ACE inhibitor, beta-blocker.',
    sources: [
      {title:'ESC Guidelines Acute Myocardial Infarction STEMI 2023', url:'https://www.escardio.org/Guidelines/Clinical-Practice-Guidelines/Acute-Myocardial-Infarction-in-patients-presenting-with-ST-segment-elevation', org:'ESC'},
      {title:'AHA/ACC NSTE-ACS Guideline 2023', url:'https://www.ahajournals.org/doi/10.1161/CIR.0000000000001165', org:'AHA/ACC'},
      {title:'NICE NG185: Acute Coronary Syndromes', url:'https://www.nice.org.uk/guidance/ng185', org:'NICE UK'}
    ]
  },
  'covid|coronavirus|sar-cov': {
    answer: 'COVID-19 symptoms include fever, cough, fatigue, and loss of taste or smell. Management for mild cases involves rest, hydration, and antipyretics. Severe cases may require oxygen therapy, corticosteroids (dexamethasone), and antivirals (remdesivir, nirmatrelvir/ritonavir). CDC recommends vaccination as the primary prevention strategy.',
    sources: [
      {title:'CDC COVID-19 Clinical Care', url:'https://www.cdc.gov/coronavirus/2019-ncov/hcp/clinical-care.html', org:'CDC'},
      {title:'WHO Therapeutics and COVID-19', url:'https://www.who.int/publications/i/item/WHO-2019-nCoV-therapeutics-2023.1', org:'WHO'},
      {title:'NIH COVID-19 Treatment Guidelines', url:'https://www.covid19treatmentguidelines.nih.gov/', org:'NIH'}
    ]
  }
};

async function searchRAG() {
  const q = document.getElementById('rag-q').value.trim();
  if (!q) return;
  const btn = document.getElementById('rag-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Searching‚Ä¶';
  const resultEl = document.getElementById('rag-result');
  resultEl.innerHTML = `<div class="card" style="text-align:center;padding:40px"><div class="spinner" style="width:28px;height:28px;border-width:3px"></div><p class="muted" style="margin-top:12px;font-size:13px">Searching medical knowledge base‚Ä¶</p></div>`;

  const apiData = await apiFetch('/api/rag/search', { method: 'POST', body: JSON.stringify({ query: q }) });
  btn.disabled = false;
  btn.innerHTML = 'üîç Search Knowledge Base';
  let answer = '', sources = [], explanation = null;
  if (apiData) {
    explanation = apiData.explanation || apiData.answer || '';
    answer = apiData.answer || explanation;
    sources = (apiData.sources || []);
  } else {
    // Local KB fallback
    const qLower = q.toLowerCase();
    let matched = null;
    for (const [pattern, data] of Object.entries(ragKB)) {
      if (new RegExp(pattern).test(qLower)) { matched = data; break; }
    }
    if (matched) { answer = matched.answer; sources = matched.sources; }
    else {
      answer = `The query '${q}' relates to clinical best practice and medical knowledge. While I don't have a specific deep-dive entry for this topic in my local curated knowledge base, clinical guidelines generally emphasize evidence-based management, patient-centered care, and adherence to established protocols from major health organizations.\n\nFor authoritative recommendations specifically regarding ${q}, I recommend consulting official clinical practice guidelines from relevant specialty societies (e.g., WHO, CDC, NICE, ADA, ACC/AHA). Always defer to a qualified healthcare professional for personalised clinical decisions.`;
      sources = [
        {title:'WHO Global Health Guidelines', url:'https://www.who.int/publications/guidelines', org:'WHO'},
        {title:'NIH MedlinePlus Medical Encyclopedia', url:'https://medlineplus.gov', org:'NIH'},
        {title:'CDC Clinical Resources & Guidelines', url:'https://www.cdc.gov/clinical-resources/index.html', org:'CDC'}
      ];
    }
  }

  const sourcesHtml = (sources || []).map((s, i) => {
    const title = s.title || s.name || 'Reference';
    const url = s.url || '#';
    const org = s.org || '';
    const isLink = s.url && s.url !== '#';
    return `
    <div class="rag-source">
      <div class="rag-src-header">
        <div class="rag-src-badge">${i+1}</div>
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--text)">${title}</div>
          <div style="font-size:11px;color:var(--text3)">${org}</div>
        </div>
        ${isLink ? `<a href="${url}" target="_blank" style="margin-left:auto;font-size:11px;color:var(--primary);text-decoration:none;font-weight:600">üîó Open ‚Üó</a>` : ''}
      </div>
    </div>`;
  }).join('');

  // Search Google for treatment
  const googleQuery = encodeURIComponent(q + ' clinical guidelines treatment');
  const googleLink = `https://www.google.com/search?q=${googleQuery}`;
  const pubmedLink = `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(q)}`;

  resultEl.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      <span class="tag tg-g">‚úì Evidence-Based</span>
      <span class="tag tg-b">Clinical Guidelines</span>
    </div>
    <div class="rag-answer-block">
      <p style="line-height:1.75;font-size:14px;color:var(--text)">${(explanation || answer).replace(/\n/g,'<br>')}</p>
    </div>
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px">üìö Sources & References</div>
    ${sourcesHtml}
    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
      <a href="${googleLink}" target="_blank" class="treatment-link" style="flex:1;min-width:200px">üîç Search Google for more treatments ‚Üó</a>
      <a href="${pubmedLink}" target="_blank" class="treatment-link" style="flex:1;min-width:200px">üìñ Search PubMed for research ‚Üó</a>
    </div>
    <div style="margin-top:12px">
      <div style="font-size:13px;font-weight:700;margin-bottom:6px">Ask a follow-up question:</div>
      <div style="display:flex;gap:8px">
        <input id="rag-followup" class="inp" placeholder="Ask a follow-up question‚Ä¶">
        <button class="btn-p" onclick="(function(){ const v=document.getElementById('rag-followup').value; if(v) { document.getElementById('rag-q').value=v; searchRAG(); } })()">Ask</button>
      </div>
    </div>`;
}

function ragQuick(q) { document.getElementById('rag-q').value = q; searchRAG(); }

// ‚îÄ‚îÄ‚îÄ PRESCRIPTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function standardizeRx() {
  try {
    const patient = document.getElementById('rx-patient').value.trim();
    const physician = document.getElementById('rx-physician').value.trim();
    const text = document.getElementById('rx-text').value.trim();
    if (!patient) { alert('‚ùå Please enter patient name.'); return; }
    if (!physician) { alert('‚ùå Please enter physician name.'); return; }
    if (!text) { alert('‚ùå Please enter prescription text.'); return; }
    
    const btn = document.getElementById('rx-btn');
    btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Processing‚Ä¶';

    console.log('Standardizing prescription...', { patient, physician, text });
    const data = await apiFetch('/api/prescriptions/standardize', {
      method: 'POST',
      body: JSON.stringify({ text, patient_name: patient, physician: physician })
    });
    console.log('Server response:', data);
    
    btn.disabled = false; btn.innerHTML = '‚ö° Standardize to FHIR R4';

    const output = data?.fhir || {
      resourceType: 'MedicationRequest', 
      id: data?.prescription_id || 'rx-' + Date.now().toString(16),
      status: 'active', 
      intent: 'order',
      subject: { display: patient },
      medicationCodeableConcept: { coding: [{ system: 'http://www.nlm.nih.gov/research/umls/rxnorm', code: 'AUTO', display: 'AI-Extracted Medication' }] },
      dosageInstruction: [{ text: text }],
      prescriber: { display: physician },
      meta: { source: 'MediSync-v3', created: new Date().toISOString(), format: 'FHIR R4' }
    };

    lastRxFhir = output;
    lastRxPatient = patient;
    
    const outputEl = document.getElementById('rx-output');
    if (outputEl) outputEl.textContent = JSON.stringify(lastRxFhir, null, 2);
    
    const savePanel = document.getElementById('rx-save-panel');
    if (savePanel) savePanel.style.display = 'block';
    
    if (data?.record) {
      console.log('Using record from server:', data.record);
      prescriptionDB.unshift(data.record);
    } else {
      const rxId = data?.prescription_id || output?.id || `rx-${Date.now().toString(16)}`;
      const newRecord = {
        id: rxId,
        patient: patient,
        physician: physician,
        timestamp: new Date().toISOString(),
        fhir: lastRxFhir,
        notes: '',
        filename: null,
        file_size: 0,
        user_id: currentUser?.id || null
      };
      console.log('Creating local record:', newRecord);
      prescriptionDB.unshift(newRecord);
    }
    console.log('Total records:', prescriptionDB.length);
    
    renderPrescriptions();
    
    setTimeout(() => {
      const gridElement = document.getElementById('rx-grid');
      console.log('Grid element:', gridElement);
      if (gridElement) {
        console.log('Scrolling to grid...');
        gridElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 200);
    
    document.getElementById('rx-patient').value = '';
    document.getElementById('rx-physician').value = '';
    document.getElementById('rx-text').value = '';
    
    alert('‚úÖ Prescription standardized and saved to Stored Records!');
    
  } catch (error) {
    console.error('Standardize error:', error);
    alert('‚ùå Error: ' + error.message);
    const btn = document.getElementById('rx-btn');
    if (btn) btn.disabled = false;
    if (btn) btn.innerHTML = '‚ö° Standardize to FHIR R4';
  }
}

async function uploadRx(input) {
  if (!input.files[0]) return;
  const file = input.files[0];
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    let preview = null;
    if (file.type.startsWith('image/')) {
      preview = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
      });
    }
    
    console.log('Uploading prescription:', file.name);
    const data = await apiFetch('/api/prescriptions/upload', { method: 'POST', headers: {}, body: fd });
    
    console.log('Upload response:', data);
    
    const ok = document.getElementById('rx-upload-ok');
    if (ok) {
      ok.classList.add('show');
      setTimeout(() => ok.classList.remove('show'), 4000);
    }
    
    if (data?.fhir) { 
      lastRxFhir = data.fhir; 
      const outputEl = document.getElementById('rx-output');
      if (outputEl) outputEl.textContent = JSON.stringify(data.fhir, null, 2);
      const savePanel = document.getElementById('rx-save-panel');
      if (savePanel) savePanel.style.display = 'block'; 
    }
    
    if (data?.record) { 
      console.log('Adding record to prescriptionDB:', data.record);
      if (preview) data.record.preview = preview;
      prescriptionDB.unshift(data.record);
      renderPrescriptions();
      
      setTimeout(() => {
        const gridElement = document.getElementById('rx-grid');
        if (gridElement) {
          console.log('Scrolling to rx-grid');
          gridElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        setTimeout(() => {
          console.log('Syncing with server...');
          loadPrescriptions();
        }, 500);
      }, 300);
    } else {
      console.warn('No record in upload response');
      setTimeout(() => {
        console.log('Reloading prescriptions from server...');
        loadPrescriptions();
      }, 500);
    }
    
    input.value = '';
  } catch (error) {
    console.error('Upload error:', error);
    alert('‚ùå Upload failed: ' + error.message);
  }
}

function saveRxAs(format) {
  if (!lastRxFhir) return;
  const patient = lastRxPatient || 'patient';
  const date = new Date().toISOString().split('T')[0];
  const filename = `prescription_${patient}_${date}`;
  if (format === 'json') { downloadFile(JSON.stringify(lastRxFhir, null, 2), filename + '.json', 'application/json'); }
  else if (format === 'txt') { downloadFile(jsonToText(lastRxFhir), filename + '.txt', 'text/plain'); }
  else if (format === 'pdf') { generateRxPDF(lastRxFhir, filename); }
  else if (format === 'docx') { downloadFile(jsonToText(lastRxFhir), filename + '.doc', 'application/msword'); }
}

function jsonToText(fhir) {
  const med = fhir?.medicationCodeableConcept?.coding?.[0]?.display || 'Unknown medication';
  const dose = fhir?.dosageInstruction?.[0]?.text || 'As directed';
  const pt = fhir?.subject?.display || 'Unknown';
  const dr = fhir?.prescriber?.display || 'Unknown';
  const date = new Date().toLocaleDateString();
  return `PRESCRIPTION RECORD
${'='.repeat(40)}
Patient: ${pt}
Physician: ${dr}
Date: ${date}
Prescription ID: ${fhir?.id || 'N/A'}

MEDICATION
----------
${med}
Dosage: ${dose}

FHIR Format: R4 MedicationRequest
Standard: HL7 FHIR R4
Generated by: MediSync AI v3.0
${'='.repeat(40)}`;
}

function generateRxPDF(fhir, filename) {
  const html = `<!DOCTYPE html><html><head><title>Prescription</title><style>body{font-family:Arial,sans-serif;padding:40px;max-width:600px}.header{border-bottom:2px solid #2563eb;padding-bottom:14px;margin-bottom:20px}.title{color:#2563eb;font-size:20px;font-weight:bold}.field{margin:10px 0;font-size:14px}.label{font-weight:bold;color:#64748b;font-size:12px;text-transform:uppercase}</style></head><body><div class="header"><div class="title">‚¨° MediSync AI ‚Äî Prescription Record</div><div style="color:#64748b;font-size:12px">FHIR R4 Standardized ‚Ä¢ ${new Date().toLocaleDateString()}</div></div><div class="label">Patient</div><div class="field">${fhir?.subject?.display || 'N/A'}</div><div class="label">Medication</div><div class="field">${fhir?.medicationCodeableConcept?.coding?.[0]?.display || 'N/A'}</div><div class="label">Dosage Instructions</div><div class="field">${fhir?.dosageInstruction?.[0]?.text || 'N/A'}</div><div class="label">Prescriber</div><div class="field">${fhir?.prescriber?.display || 'N/A'}</div><div class="label">Prescription ID</div><div class="field" style="font-family:monospace">${fhir?.id || 'N/A'}</div></body></html>`;
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename + '.html'; // Opens like PDF
  a.click();
}

function downloadFile(content, filename, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type }));
  a.download = filename;
  a.click();
}

let prescriptionDB = [];

async function loadPrescriptions() {
  try {
    console.log('Loading prescriptions from server...');
    const data = await apiFetch('/api/prescriptions');
    console.log('Server response:', data);
    prescriptionDB = data?.prescriptions || [];
    console.log('‚úì Loaded', prescriptionDB.length, 'prescriptions');
    prescriptionDB.forEach((p, i) => {
      console.log(`  [${i}]`, p.id, '-', p.patient, '(', p.filename || 'manual', ')');
    });
  } catch (e) {
    console.error('‚ùå Error loading prescriptions:', e);
    prescriptionDB = [];
  }
  renderPrescriptions();
}

function renderPrescriptions() {
  const filterPt = (document.getElementById('rx-filter-patient')?.value || '').toLowerCase();
  const filtered = prescriptionDB.filter(p => !filterPt || p.patient.toLowerCase().includes(filterPt));
  
  const total = prescriptionDB.length;
  const uploaded = prescriptionDB.filter(p => p.filename).length;
  setEl('rx-count-total', total);
  setEl('rx-count-uploaded', uploaded);

  const grid = document.getElementById('rx-grid');
  if (!grid) {
    console.error('rx-grid element not found');
    return;
  }
  if (!filtered.length) {
    grid.innerHTML = '<div class="card" style="text-align:center;padding:28px;grid-column:1/-1"><p class="muted" style="font-size:13px">No prescriptions found. Upload a prescription using the form above.</p></div>';
    return;
  }
  grid.innerHTML = filtered.map((p, idx) => {
    const med = p.fhir?.medicationCodeableConcept?.coding?.[0]?.display || 'Medication';
    const dose = p.fhir?.dosageInstruction?.[0]?.text || 'As directed';
    const fileExt = p.filename ? p.filename.split('.').pop().toUpperCase() : null;
    const pt_id = `PT-${String(idx+1).padStart(5, '0')}`;
    const hasThumbnail = p.filename && (fileExt === 'JPG' || fileExt === 'PNG' || fileExt === 'JPEG');
    
    return `
    <div class="scan-card">
      <div class="scan-thumb" onclick="viewPrescription('${p.id}')" style="cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:48px;background:linear-gradient(135deg,#fce7f3,#fbcfe8);position:relative">
        ${p.preview ? `<img src="${p.preview}" style="width:100%;height:100%;object-fit:cover">` : 'üíä'}
        ${p.filename ? `<span style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.7);color:white;padding:3px 7px;border-radius:4px;font-size:10px;font-weight:bold">${fileExt}</span>` : ''}
      </div>
      <div class="scan-info">
        <h4>${p.patient || 'Unknown Patient'}</h4>
        <div style="font-size:12px;color:var(--text3)">${pt_id} ‚Ä¢ ${p.physician || 'Unknown'}</div>
        <div class="scan-badge-row">
          <span class="tag tg-b">${med}</span>
          ${fileExt ? `<span class="tag tg-g">${fileExt}</span>` : '<span class="tag" style="background:var(--surface3);color:var(--text3)">Manual</span>'}
        </div>
        <div style="font-size:12px;color:var(--text2);margin-top:8px;font-weight:500">${dose}</div>
        ${p.notes ? `<div style="font-size:11px;color:var(--text3);margin-top:6px">${p.notes.substring(0,70)}${p.notes.length>70?'‚Ä¶':''}</div>` : ''}
        <div style="font-size:11px;color:var(--text4);margin-top:4px">${new Date(p.timestamp).toLocaleDateString()}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-s" style="font-size:12px" onclick="downloadPrescription('${p.id}','pdf')">üìÑ PDF</button>
          <button class="btn-s" style="font-size:12px" onclick="downloadPrescription('${p.id}','image')">üñºÔ∏è Image</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function viewPrescription(id) {
  const rx = prescriptionDB.find(p => p.id === id);
  if (!rx) return;
  const med = rx.fhir?.medicationCodeableConcept?.coding?.[0];
  const dose = rx.fhir?.dosageInstruction?.[0]?.text || 'As directed';
  
  document.getElementById('rx-modal-title').textContent = `üíä ${med?.display || 'Prescription'} ‚Äî ${rx.patient}`;
  document.getElementById('rx-modal-content').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div><div class="field"><label>Patient</label><div style="font-size:14px;font-weight:600">${rx.patient || 'Unknown'}</div></div></div>
      <div><div class="field"><label>Physician</label><div style="font-size:14px">${rx.physician || 'Unknown'}</div></div></div>
    </div>
    ${rx.preview ? `<img src="${rx.preview}" style="width:100%;border-radius:10px;margin-bottom:12px;max-height:400px;object-fit:contain">` : ''}
    <div class="field"><label>Medication</label><div style="font-size:14px;font-weight:600">${med?.display || 'N/A'}</div></div>
    <div class="field"><label>Dosage Instructions</label><div style="font-size:13px;color:var(--text2)">${dose}</div></div>
    ${rx.notes ? `<div class="field"><label>Clinical Notes</label><p style="font-size:13px;color:var(--text2)">${rx.notes}</p></div>` : ''}
    ${rx.filename ? `<div class="field"><label>File</label><div style="font-size:12px;font-family:monospace;color:var(--text3)">${rx.filename} (${(rx.file_size/1024).toFixed(1)} KB)</div></div>` : ''}
    <div style="font-size:12px;color:var(--text3);margin-bottom:14px">Created: ${new Date(rx.timestamp).toLocaleString()}</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn-p" style="font-size:13px;padding:10px 16px" onclick="downloadPrescription('${id}','pdf')">üìÑ Download PDF</button>
      <button class="btn-s" style="font-size:13px;padding:10px 16px" onclick="downloadPrescription('${id}','image')">üñºÔ∏è Download Image</button>
    </div>`;
  document.getElementById('rx-viewer-modal').classList.add('open');
}

// Download prescription by id and format
async function downloadPrescription(id, format) {
  try {
    const rx = prescriptionDB.find(p => p.id === id);
    if (!rx) { alert('‚ùå Prescription not found'); return; }
    
    const med = rx.fhir?.medicationCodeableConcept?.coding?.[0];
    const dose = rx.fhir?.dosageInstruction?.[0]?.text || 'As directed';
    const safeFilename = rx.patient.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    
    if (format === 'image') {
      if (!rx.preview) { 
        alert('‚ö†Ô∏è No image available. PDF download only.'); 
        return; 
      }
      const a = document.createElement('a');
      a.href = rx.preview;
      a.download = `prescription_${safeFilename}_${id}.png`;
      a.click();
      console.log('‚úì Image downloaded:', a.download);
      return;
    }
    
    if (format === 'pdf') {
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Prescription - ${rx.patient}</title>
  <style>
    * { margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; max-width: 700px; margin: 0 auto; line-height: 1.8; color: #1f2937; }
    .header { border-bottom: 3px solid #2563eb; padding-bottom: 24px; margin-bottom: 32px; }
    .logo { color: #2563eb; font-size: 24px; font-weight: bold; margin-bottom: 8px; }
    .subtitle { color: #6b7280; font-size: 13px; }
    .section { margin-bottom: 24px; }
    .label { font-weight: 600; color: #4b5563; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .value { font-size: 15px; color: #1f2937; margin-bottom: 4px; }
    .field { margin-bottom: 18px; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .fhir { background: #f3f4f6; border-left: 4px solid #2563eb; padding: 16px; border-radius: 4px; margin-top: 24px; }
    .fhir-title { font-weight: 700; margin-bottom: 12px; color: #2563eb; }
    .fhir-code { font-family: 'Courier New', monospace; font-size: 11px; color: #4b5563; white-space: pre-wrap; word-break: break-word; }
    .footer { border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 32px; font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">‚¨° MediSync AI</div>
    <div class="subtitle">Prescription Record ‚Ä¢ FHIR R4 Standardized</div>
  </div>
  
  <div class="two-col">
    <div>
      <div class="label">Patient Name</div>
      <div class="value">${rx.patient || 'N/A'}</div>
    </div>
    <div>
      <div class="label">Physician</div>
      <div class="value">${rx.physician || 'N/A'}</div>
    </div>
  </div>
  
  <div class="section">
    <div class="label">Medication</div>
    <div class="value" style="font-weight: 600; font-size: 16px; color: #2563eb;">${med?.display || 'N/A'}</div>
  </div>
  
  <div class="section">
    <div class="label">Dosage Instructions</div>
    <div class="value">${dose}</div>
  </div>
  
  ${rx.notes ? `<div class="section">
    <div class="label">Clinical Notes</div>
    <div class="value">${rx.notes}</div>
  </div>` : ''}
  
  ${rx.filename ? `<div class="section">
    <div class="label">Source File</div>
    <div class="value">${rx.filename} (${(rx.file_size/1024).toFixed(1)} KB)</div>
  </div>` : ''}
  
  <div class="fhir">
    <div class="fhir-title">FHIR R4 Medical Record</div>
    <div class="fhir-code">${JSON.stringify(rx.fhir, null, 2).replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
  </div>
  
  <div class="footer">
    <p>Generated: ${new Date().toLocaleString()}</p>
    <p>Prescription ID: <strong>${id}</strong></p>
    <p>Status: Active</p>
  </div>
</body>
</html>`;
      
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `prescription_${safeFilename}_${id}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      console.log('‚úì PDF downloaded:', link.download);
      return;
    }
    
    alert('‚ö†Ô∏è Download format not supported');
  } catch (error) {
    console.error('Download error:', error);
    alert('‚ùå Download failed: ' + error.message);
  }
}

// ‚îÄ‚îÄ‚îÄ SCAN STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SCAN_ICONS = { mri:'üß†', xray:'ü¶¥', ct:'üî¨', ultrasound:'ü´Ä', ecg:'üìà', echo:'ü´Å', pet:'‚ö°', other:'ü©∫' };
const SCAN_LABELS = { mri:'MRI Scan', xray:'X-Ray', ct:'CT Scan', ultrasound:'Ultrasound', ecg:'ECG', echo:'Echocardiogram', pet:'PET Scan', other:'Scan' };

function saveScan() {
  const patient = document.getElementById('scan-patient').value.trim();
  const pid = document.getElementById('scan-pid').value.trim();
  const type = document.getElementById('scan-type').value;
  const region = document.getElementById('scan-region').value;
  const notes = document.getElementById('scan-notes').value.trim();
  const dr = document.getElementById('scan-dr').value.trim();
  const fileInput = document.getElementById('scan-file');
  const file = fileInput.files[0];

  const scan = {
    id: 'SCN-' + Date.now(),
    patient: patient || 'Unknown Patient',
    pid: pid || 'PT-' + Math.floor(Math.random()*90000+10000),
    type, region, notes, physician: dr,
    filename: file ? file.name : null,
    fileType: file ? file.type : null,
    date: new Date().toISOString(),
    preview: null
  };

  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = e => { scan.preview = e.target.result; scanDB.unshift(scan); renderScans(); };
    reader.readAsDataURL(file);
  } else {
    scanDB.unshift(scan);
    renderScans();
  }

  const ok = document.getElementById('scan-ok');
  ok.textContent = `‚úÖ Scan saved: ${SCAN_LABELS[type]} for ${patient || 'patient'}`;
  ok.classList.add('show');
  setTimeout(() => ok.classList.remove('show'), 3000);
  fileInput.value = '';
  document.getElementById('scan-patient').value = '';
  document.getElementById('scan-notes').value = '';
}

function renderScans() {
  const filterType = document.getElementById('scan-filter-type')?.value || '';
  const filterPt = (document.getElementById('scan-filter-patient')?.value || '').toLowerCase();
  const filtered = scanDB.filter(s => (!filterType || s.type === filterType) && (!filterPt || s.patient.toLowerCase().includes(filterPt)));
  
  const total = scanDB.length;
  const mri = scanDB.filter(s => s.type === 'mri').length;
  const xray = scanDB.filter(s => s.type === 'xray').length;
  const ct = scanDB.filter(s => s.type === 'ct').length;
  setEl('scan-count-total', total);
  setEl('scan-count-mri', mri);
  setEl('scan-count-xray', xray);
  setEl('scan-count-ct', ct);

  const grid = document.getElementById('scan-grid');
  if (!filtered.length) {
    grid.innerHTML = '<div class="card" style="text-align:center;padding:28px;grid-column:1/-1"><p class="muted" style="font-size:13px">No scans found. Upload a scan using the form above.</p></div>';
    return;
  }
  grid.innerHTML = filtered.map(s => `
    <div class="scan-card">
      <div class="scan-thumb" onclick="viewScan('${s.id}')">
        ${s.preview ? `<img src="${s.preview}" style="width:100%;height:100%;object-fit:cover">` : SCAN_ICONS[s.type] || 'ü©∫'}
      </div>
      <div class="scan-info">
        <h4>${s.patient}</h4>
        <div style="font-size:12px;color:var(--text3)">${s.pid} ‚Ä¢ ${s.region}</div>
        <div class="scan-badge-row">
          <span class="tag tg-b">${SCAN_LABELS[s.type]}</span>
          ${s.filename ? `<span class="tag tg-g">${s.filename.split('.').pop().toUpperCase()}</span>` : ''}
        </div>
        ${s.notes ? `<div style="font-size:11px;color:var(--text3);margin-top:6px">${s.notes.substring(0,60)}${s.notes.length>60?'‚Ä¶':''}</div>` : ''}
        <div style="font-size:11px;color:var(--text4);margin-top:4px">${new Date(s.date).toLocaleDateString()}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-s" style="font-size:12px" onclick="downloadScan('${s.id}','pdf')">‚¨áÔ∏è PDF</button>
          <button class="btn-s" style="font-size:12px" onclick="downloadScan('${s.id}','image')">‚¨áÔ∏è Image</button>
        </div>
      </div>
    </div>`).join('');
// Download scan by id and format
async function downloadScan(id, format) {
  const token = localStorage.getItem('medisync_token');
  let url = `/api/scans/download/${id}`;
  if (format === 'image') url += '?format=image';
  else url += '?format=pdf';
  try {
    const res = await fetch(API + url, {
      headers: token ? { 'Authorization': 'Bearer ' + token } : {}
    });
    if (!res.ok) { alert('Failed to download scan.'); return; }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `scan_${id}.${format === 'image' ? 'png' : 'pdf'}`;
    a.click();
  } catch (e) { alert('Download error.'); }
}
}

function viewScan(id) {
  const scan = scanDB.find(s => s.id === id);
  if (!scan) return;
  document.getElementById('scan-modal-title').textContent = `${SCAN_LABELS[scan.type]} ‚Äî ${scan.patient}`;
  document.getElementById('scan-modal-content').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
      <div><div class="field"><label>Patient</label><div style="font-size:14px;font-weight:600">${scan.patient}</div></div></div>
      <div><div class="field"><label>Patient ID</label><div style="font-size:14px;font-family:'JetBrains Mono',monospace">${scan.pid}</div></div></div>
      <div><div class="field"><label>Scan Type</label><span class="tag tg-b">${SCAN_LABELS[scan.type]}</span></div></div>
      <div><div class="field"><label>Body Region</label><div style="font-size:14px">${scan.region}</div></div></div>
    </div>
    ${scan.preview ? `<img src="${scan.preview}" style="width:100%;border-radius:10px;margin-bottom:12px">` : `<div style="background:var(--surface3);border-radius:10px;padding:48px;text-align:center;font-size:56px;margin-bottom:12px">${SCAN_ICONS[scan.type]}</div>`}
    ${scan.notes ? `<div class="field"><label>Clinical Notes</label><p style="font-size:13px;color:var(--text2)">${scan.notes}</p></div>` : ''}
    ${scan.physician ? `<div class="field"><label>Requesting Physician</label><p style="font-size:13px">${scan.physician}</p></div>` : ''}
    <div style="font-size:12px;color:var(--text3)">Recorded: ${new Date(scan.date).toLocaleString()}</div>`;
  document.getElementById('scan-viewer-modal').classList.add('open');
}

// ‚îÄ‚îÄ‚îÄ RISK AI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchRiskModule(mod) {
  document.querySelectorAll('#risk-module-tabs .chip').forEach(c => c.classList.remove('sel'));
  document.querySelector(`#risk-module-tabs .chip[onclick*="${mod}"]`).classList.add('sel');
  ['single','batch','urgent'].forEach(m => {
    const el = document.getElementById('risk-' + m);
    if (el) el.style.display = m === mod ? 'block' : 'none';
  });
  if (mod === 'urgent') renderUrgentQueue();
}

function calcRiskScore(d) {
  let score = 0;
  const factors = [];
  
  // Age
  if (d.age >= 75) { score += 25; factors.push({ label: 'Age ‚â• 75 years', impact: 'high', points: 25, explanation: 'Very advanced age is a critical independent risk factor for cardiovascular complications.' }); }
  else if (d.age >= 65) { score += 15; factors.push({ label: 'Age 65‚Äì74 years', impact: 'high', points: 15, explanation: 'Advanced age significantly increases risk.' }); }
  else if (d.age >= 45) { score += 8; factors.push({ label: 'Age 45‚Äì64 years', impact: 'medium', points: 8, explanation: 'Risk begins to increase substantially from age 45.' }); }
  
  // BP
  if (d.sbp >= 180 || d.dbp >= 120) { score += 40; factors.push({ label: 'Hypertensive Crisis', impact: 'critical', points: 40, explanation: 'BP ‚â• 180/120 mmHg is a medical emergency requiring immediate intervention.' }); }
  else if (d.sbp >= 160 || d.dbp >= 100) { score += 20; factors.push({ label: 'Stage 2 Hypertension', impact: 'high', points: 20, explanation: 'Stage 2 hypertension significantly increases cardiovascular event risk.' }); }
  else if (d.sbp >= 140 || d.dbp >= 90) { score += 12; factors.push({ label: 'Stage 1 Hypertension', impact: 'medium', points: 12, explanation: 'Elevated BP requires clinical management.' }); }
  
  // Sugar
  if (d.sugar >= 250) { score += 35; factors.push({ label: 'Severe Hyperglycemia', impact: 'critical', points: 35, explanation: 'Blood sugar ‚â• 250 mg/dL is extremely dangerous and risks acute metabolic crisis.' }); }
  else if (d.sugar >= 126) { score += 20; factors.push({ label: 'Diabetic Range', impact: 'high', points: 20, explanation: 'Fasting glucose ‚â• 126 mg/dL indicates Diabetes Mellitus.' }); }
  
  // BMI
  if (d.bmi >= 40) { score += 20; factors.push({ label: 'Morbid Obesity (BMI ‚â• 40)', impact: 'high', points: 20, explanation: 'Class III obesity is a major risk for multiple chronic conditions.' }); }
  else if (d.bmi >= 30) { score += 10; factors.push({ label: 'Obesity (BMI ‚â• 30)', impact: 'medium', points: 10, explanation: 'Obesity is a major modifiable risk factor.' }); }

  // Smoking
  if (d.smoking === 'Current Smoker') { score += 20; factors.push({ label: 'Current Smoker', impact: 'high', points: 20, explanation: 'Smoking is a primary driver of cardiovascular disease.' }); }

  // Symptoms
  if (d.symptoms) {
    const s = d.symptoms.toLowerCase();
    if (s.includes('chest pain')) { score += 30; factors.push({ label: 'Acute Chest Pain', impact: 'critical', points: 30, explanation: 'Red flag: Possible acute coronary syndrome.' }); }
    if (s.includes('shortness of breath')) { score += 20; factors.push({ label: 'Dyspnoea', impact: 'high', points: 20, explanation: 'Red flag: Possible cardiac or respiratory failure.' }); }
  }

  score = Math.min(score, 100);
  const level = score >= 70 ? 'High' : score >= 40 ? 'Medium' : 'Low';
  const urgency = score >= 70 ? 'CRITICAL' : score >= 45 ? 'HIGH' : score >= 20 ? 'MODERATE' : 'ROUTINE';
  return { score, level, urgency, factors };
}

async function predictRisk() {
  const d = {
    age: parseInt(document.getElementById('r-age').value) || 0,
    gender: document.getElementById('r-gender').value,
    sbp: parseInt(document.getElementById('r-sbp').value) || 0,
    dbp: parseInt(document.getElementById('r-dbp').value) || 80,
    sugar: parseInt(document.getElementById('r-sugar').value) || 0,
    bmi: parseFloat(document.getElementById('r-bmi').value) || 0,
    chol: parseInt(document.getElementById('r-chol').value) || 0,
    smoking: document.getElementById('r-smoke').value || 'Non-Smoker',
    hr: parseInt(document.getElementById('r-hr').value) || 75,
    fhx: document.getElementById('r-fhx').value,
    meds: document.getElementById('r-meds').value,
    symptoms: document.getElementById('r-symptoms').value
  };

  if (!d.age || !d.sbp || !d.sugar) { alert('Please fill in Age, BP, and Blood Sugar fields.'); return; }

  const btn = document.getElementById('risk-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Analyzing‚Ä¶';

  // Try API, fallback to local
  const apiData = await apiFetch('/api/predict-risk', { 
    method: 'POST', 
    body: JSON.stringify({ 
      age: d.age, 
      bp: d.sbp, 
      dbp: d.dbp, 
      sugar: d.sugar, 
      bmi: d.bmi, 
      cholesterol: d.chol, 
      smoking: d.smoking, 
      gender: d.gender,
      heart_rate: d.hr,
      family_history_cvd: d.fhx,
      symptoms: d.symptoms,
      medications: d.meds
    }) 
  });
  btn.disabled = false; btn.innerHTML = '‚ö° Predict Risk Level';

  const local = calcRiskScore(d);
  
  let finalResult;
  if (apiData) {
    finalResult = {
      score: apiData.score,
      level: apiData.risk_level,
      urgency: apiData.urgency,
      factors: apiData.key_factors || [],
      explanations: apiData.explanations || [],
      recommendations: apiData.recommendations || [],
      is_ai_enhanced: apiData.is_ai_enhanced || false
    };
  } else {
    finalResult = {
      score: local.score,
      level: local.level,
      urgency: local.urgency,
      factors: local.factors.map(f => f.label),
      explanations: local.factors.map(f => f.explanation),
      recommendations: ["Seek medical advice for accurate diagnosis"],
      is_ai_enhanced: false
    };
  }

  const { score, level, urgency, factors, explanations, recommendations, is_ai_enhanced } = finalResult;

  // Add to urgent queue if high risk
  if (urgency === 'CRITICAL' || urgency === 'HIGH') {
    const patientId = 'PT-' + Math.floor(Math.random()*90000+10000);
    urgentQueue.unshift({ 
      id: patientId, 
      age: d.age, 
      sbp: d.sbp, 
      sugar: d.sugar, 
      score, 
      level, 
      urgency, 
      symptoms: d.symptoms, 
      timestamp: new Date().toISOString() 
    });
    const badge = document.getElementById('adr-nav-badge');
    if (badge) {
        badge.classList.add('show');
        badge.textContent = urgentQueue.filter(u => u.urgency === 'CRITICAL' || u.urgency === 'HIGH').length;
    }
  }

  renderRiskResult({ score, level, urgency, factors, explanations, recommendations, is_ai_enhanced, d });
}

function renderRiskResult({ score, level, urgency, factors, explanations, recommendations, is_ai_enhanced, d }) {
  const colors = { Low: '#059669', Medium: '#d97706', High: '#dc2626', CRITICAL: '#dc2626', HIGH: '#dc2626', MEDIUM: '#d97706', LOW: '#059669' };
  const urgColor = colors[urgency] || '#64748b';
  const scoreColor = colors[level] || '#64748b';

  const urgencyBanner = (urgency === 'CRITICAL' || urgency === 'HIGH') ? `
    <div class="urgency-banner urg-${urgency.toLowerCase()}" style="margin-bottom:14px">
      <div style="font-size:28px">${urgency === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è'}</div>
      <div>
        <div style="font-weight:800;color:var(--danger);font-size:15px">${urgency} PRIORITY ‚Äî Immediate Attention Required</div>
        <div style="font-size:13px;color:var(--text3);margin-top:3px">${urgency === 'CRITICAL' ? 'This patient may require emergency intervention. Contact clinical team immediately.' : 'This patient has high risk indicators. Schedule priority review within 24 hours.'}</div>
      </div>
    </div>` : '';

  const aiBadge = is_ai_enhanced ? `<div class="tag tg-v" style="margin-bottom:8px;font-size:11px">‚ú® AI Enhanced Clinical Analysis</div>` : '';

  const googleQuery = encodeURIComponent(`treatment for ${level} cardiovascular risk ${d.age} years old ${d.sbp > 140 ? 'hypertension' : ''} ${d.sugar > 126 ? 'diabetes' : ''}`);

  const factorsHtml = factors.map((f, i) => `
    <div class="risk-factor">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
        <span style="font-size:13px;font-weight:600;color:var(--text)">${f}</span>
      </div>
      <div style="font-size:11.5px;color:var(--text3);line-height:1.5">${explanations[i] || ''}</div>
    </div>`).join('');

  const recsHtml = (recommendations || []).map(r => `
    <div style="display:flex;gap:8px;margin-bottom:6px;font-size:12.5px;color:var(--text2)">
      <span>‚úÖ</span>
      <span>${r}</span>
    </div>`).join('');

  document.getElementById('risk-panel').innerHTML = `
    ${urgencyBanner}
    <div class="card" style="margin-bottom:14px">
      ${aiBadge}
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:16px">
        <div style="text-align:center">
          <div style="font-size:48px;font-weight:800;color:${scoreColor};font-family:'Fraunces',serif;line-height:1">${score}%</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px">Risk Score</div>
        </div>
        <div style="flex:1">
          <div class="tag ${level === 'High' ? 'tg-r' : level === 'Medium' ? 'tg-y' : 'tg-g'}" style="font-size:14px;padding:6px 16px;margin-bottom:8px">${level} Risk</div>
          <div class="bar-bg" style="margin-bottom:6px"><div class="bar-fill" style="width:${score}%;background:${scoreColor}"></div></div>
          <div style="font-size:12px;color:var(--text3)">Clinical Analysis Result</div>
        </div>
      </div>
      <div class="risk-factors-grid">${factorsHtml}</div>
    </div>
    
    ${recsHtml ? `
    <div class="card" style="margin-bottom:14px;background:var(--primary-l);border-color:rgba(37,99,235,0.1)">
      <h4 style="margin-bottom:10px;display:flex;align-items:center;gap:6px;font-size:14px">üìã AI Recommended Next Steps</h4>
      ${recsHtml}
    </div>` : ''}

    <div class="card card-sm">
      <h3 style="margin-bottom:12px">üí° Professional Resources</h3>
      <a href="https://www.google.com/search?q=${googleQuery}" target="_blank" class="treatment-link">üîç Search Google: Treatment for ${level} Risk Profile ‚Üó</a>
      <a href="https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(`${level.toLowerCase()} cardiovascular risk management guidelines`)}" target="_blank" class="treatment-link">üìñ PubMed: Clinical Guidelines ‚Üó</a>
      <a href="https://www.acc.org/guidelines" target="_blank" class="treatment-link">‚ù§Ô∏è ACC/AHA Cardiovascular Guidelines ‚Üó</a>
      ${level === 'High' || urgency === 'CRITICAL' ? `<a href="https://www.heart.org/en/professional/quality-improvement/ahaecc/emergency" target="_blank" class="treatment-link" style="background:var(--danger-l);border-color:rgba(220,38,38,.3);color:var(--danger)">üö® AHA Emergency Cardiac Care ‚Üó</a>` : ''}
    </div>`;
}

function addBatchRow() {
  const row = document.createElement('div');
  row.className = 'batch-row';
  row.style = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:10px';
  row.innerHTML = `<div class="field" style="margin-bottom:0"><input class="inp" placeholder="Name" style="font-size:12px"></div><div class="field" style="margin-bottom:0"><input class="inp" type="number" placeholder="Age" style="font-size:12px"></div><div class="field" style="margin-bottom:0"><input class="inp" type="number" placeholder="BP" style="font-size:12px"></div><div class="field" style="margin-bottom:0"><input class="inp" type="number" placeholder="Sugar" style="font-size:12px"></div><div class="field" style="margin-bottom:0"><input class="inp" type="number" placeholder="BMI" style="font-size:12px"></div><button class="btn-danger" onclick="this.parentElement.remove()" style="padding:10px 12px">‚úï</button>`;
  document.getElementById('batch-patients').appendChild(row);
}

function runBatchRisk() {
  const rows = document.querySelectorAll('.batch-row');
  const results = [];
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const d = { name: inputs[0].value || 'Unknown', age: parseInt(inputs[1].value) || 50, sbp: parseInt(inputs[2].value) || 120, sugar: parseInt(inputs[3].value) || 90, bmi: parseFloat(inputs[4].value) || 25, chol: 0, smoking: 'Non-Smoker', hr: 75, fhx: 'no' };
    const r = calcRiskScore(d);
    results.push({ ...d, ...r });
    if (r.urgency === 'CRITICAL' || r.urgency === 'HIGH') {
      urgentQueue.unshift({ id: 'PT-' + Date.now().toString().slice(-5), age: d.age, sbp: d.sbp, sugar: d.sugar, score: r.score, level: r.level, urgency: r.urgency, timestamp: new Date().toISOString() });
    }
  });
  results.sort((a, b) => b.score - a.score);
  const container = document.getElementById('batch-results');
  container.innerHTML = `
    <div style="font-size:14px;font-weight:700;margin-bottom:12px">üìä Batch Results ‚Äî Sorted by Risk</div>
    <div style="overflow-x:auto"><table>
      <thead><tr><th>Patient</th><th>Age</th><th>BP</th><th>Sugar</th><th>Score</th><th>Risk Level</th><th>Urgency</th></tr></thead>
      <tbody>${results.map(r => `
        <tr class="${r.urgency === 'CRITICAL' ? 'critical-row' : ''}">
          <td style="font-weight:600">${r.name}</td>
          <td>${r.age}</td>
          <td>${r.sbp}</td>
          <td>${r.sugar}</td>
          <td style="font-weight:700;color:${r.level === 'High' ? '#dc2626' : r.level === 'Medium' ? '#d97706' : '#059669'}">${r.score}%</td>
          <td><span class="tag ${r.level === 'High' ? 'tg-r' : r.level === 'Medium' ? 'tg-y' : 'tg-g'}">${r.level}</span></td>
          <td><span class="tag ${r.urgency === 'CRITICAL' ? 'tg-r' : r.urgency === 'HIGH' ? 'tg-y' : 'tg-g'}">${r.urgency}</span></td>
        </tr>`).join('')}
      </tbody>
    </table></div>
    ${urgentQueue.length ? `<div class="alert al-w show" style="margin-top:12px;font-size:13px">‚ö†Ô∏è ${urgentQueue.length} patient(s) added to Urgent Queue. <button onclick="switchRiskModule('urgent')" style="background:none;border:none;color:var(--warn);font-weight:700;cursor:pointer">View Queue ‚Üí</button></div>` : ''}`;
}

function renderUrgentQueue() {
  const el = document.getElementById('urgent-queue');
  const countEl = document.getElementById('urgent-count');
  if (!el) return;
  const urgent = urgentQueue;
  if (countEl) countEl.textContent = `${urgent.length} Urgent`;
  if (!urgent.length) { el.innerHTML = '<p class="muted" style="text-align:center;padding:24px;font-size:13px">No urgent patients. Run risk predictions to populate this queue.</p>'; return; }
  el.innerHTML = urgent.map(p => `
    <div class="urgency-banner urg-${p.urgency.toLowerCase()}" style="margin-bottom:10px">
      <div style="font-size:24px">${p.urgency === 'CRITICAL' ? 'üö®' : '‚ö†Ô∏è'}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:14px">${p.id} ‚Äî Age ${p.age}</div>
        <div style="font-size:12px;color:var(--text3)">BP: ${p.sbp} mmHg ‚Ä¢ Sugar: ${p.sugar} mg/dL ‚Ä¢ Score: ${p.score}%</div>
        ${p.symptoms ? `<div style="font-size:12px;color:var(--danger);margin-top:3px">Symptoms: ${p.symptoms}</div>` : ''}
      </div>
      <div><span class="tag tg-r">${p.urgency}</span></div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ ADR SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const adrDB = {
  'warfarin+aspirin': { severity: 'critical', reaction: 'Significantly increased bleeding risk. Warfarin anticoagulant effect may be potentiated.', mechanism: 'Pharmacodynamic synergy ‚Äî both drugs impair haemostasis through different mechanisms.', action: 'Avoid combination unless benefit outweighs risk. Monitor INR closely. Consider gastroprotection.', source: 'BNF Drug Interaction Checker', sourceUrl: 'https://bnf.nice.org.uk/interaction/warfarin/' },
  'warfarin+ibuprofen': { severity: 'critical', reaction: 'Increased bleeding risk + possible INR elevation. NSAIDs can displace warfarin from protein binding.', mechanism: 'Pharmacokinetic (displacement) + pharmacodynamic (anti-platelet, GI mucosal damage).', action: 'Avoid. Use paracetamol/acetaminophen for analgesia instead. Monitor INR if unavoidable.', source: 'Drugs.com Interaction Checker', sourceUrl: 'https://www.drugs.com/interactions-check.php' },
  'maoi+ssri': { severity: 'critical', reaction: 'Potentially fatal Serotonin Syndrome: hyperthermia, agitation, tremor, hyperreflexia, autonomic instability.', mechanism: 'Excessive serotonergic activity from combined MAO inhibition and serotonin reuptake inhibition.', action: 'ABSOLUTE CONTRAINDICATION. Allow 14 days washout after stopping MAOI before starting SSRI (5 weeks for fluoxetine).', source: 'FDA Drug Safety Communication', sourceUrl: 'https://www.fda.gov/drugs/postmarket-drug-safety-information-patients-and-providers' },
  'metformin+contrast': { severity: 'moderate', reaction: 'Risk of contrast-induced nephropathy and lactic acidosis.', mechanism: 'Contrast dye reduces renal function, impairing metformin excretion leading to accumulation.', action: 'Hold metformin 48 hours before and after contrast administration. Check renal function before resuming.', source: 'ACR Manual on Contrast Media', sourceUrl: 'https://www.acr.org/Clinical-Resources/Contrast-Manual' },
  'ace+potassium': { severity: 'moderate', reaction: 'Hyperkalaemia risk. Combined potassium-sparing effect can cause dangerous potassium elevation.', mechanism: 'ACE inhibitors reduce aldosterone, increasing K+ retention. K-sparing diuretics have same effect.', action: 'Monitor serum potassium closely. Avoid unless specifically indicated (e.g. heart failure with close monitoring).', source: 'NICE BNF Drug Interactions', sourceUrl: 'https://bnf.nice.org.uk' },
  'statin+grapefruit': { severity: 'minor', reaction: 'Increased statin plasma levels, raising risk of myopathy and rhabdomyolysis.', mechanism: 'Grapefruit inhibits CYP3A4 enzyme, reducing first-pass metabolism of some statins (atorvastatin, simvastatin).', action: 'Advise patient to avoid grapefruit juice. Pravastatin and rosuvastatin are not affected by CYP3A4.', source: 'FDA Grapefruit Juice and Some Drugs', sourceUrl: 'https://www.fda.gov/consumers/consumer-updates/grapefruit-juice-and-some-drugs-dont-mix' }
};

function checkADR() {
  const drug1 = document.getElementById('adr-drug1').value.trim().toLowerCase();
  const drug2 = document.getElementById('adr-drug2').value.trim().toLowerCase();
  const age = document.getElementById('adr-age').value;
  const conditions = document.getElementById('adr-conditions').value;
  if (!drug1 || !drug2) { alert('Please enter both drug names.'); return; }

  const btn = document.getElementById('adr-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Checking‚Ä¶';

  setTimeout(() => {
    btn.disabled = false; btn.innerHTML = '‚ö° Check ADR Risk';
    
    // Check known combos
    let matched = null;
    const key1 = `${drug1}+${drug2}`;
    const key2 = `${drug2}+${drug1}`;
    for (const [k, v] of Object.entries(adrDB)) {
      const drugs = k.split('+');
      if ((drug1.includes(drugs[0]) || drugs[0].includes(drug1)) && (drug2.includes(drugs[1]) || drugs[1].includes(drug2))) { matched = v; break; }
      if ((drug2.includes(drugs[0]) || drugs[0].includes(drug2)) && (drug1.includes(drugs[1]) || drugs[1].includes(drug1))) { matched = v; break; }
    }

    const resultEl = document.getElementById('adr-result');
    if (matched) {
      const sev = matched.severity;
      const cls = sev === 'critical' ? 'adr-alert' : sev === 'moderate' ? 'adr-alert adr-mild' : 'adr-alert adr-info';
      const icon = sev === 'critical' ? 'üö®' : sev === 'moderate' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      adrCounts[sev === 'critical' ? 'critical' : sev === 'moderate' ? 'moderate' : 'minor']++;
      updateADRCounts();
      const googleQ = encodeURIComponent(`${drug1} ${drug2} drug interaction management`);
      resultEl.innerHTML = `
        <div class="${cls}">
          <div class="adr-icon">${icon}</div>
          <div>
            <div style="font-weight:800;font-size:14px;margin-bottom:6px">${sev.toUpperCase()} INTERACTION DETECTED</div>
            <div style="font-weight:600;margin-bottom:4px">${drug1.toUpperCase()} + ${drug2.toUpperCase()}</div>
            <p style="font-size:13px;margin-bottom:8px"><strong>Reaction:</strong> ${matched.reaction}</p>
            <p style="font-size:12px;color:var(--text3);margin-bottom:6px"><strong>Mechanism:</strong> ${matched.mechanism}</p>
            <p style="font-size:13px;font-weight:600;color:${sev==='critical'?'var(--danger)':'var(--warn)'}"><strong>Action:</strong> ${matched.action}</p>
            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <a href="${matched.sourceUrl}" target="_blank" class="source-link" style="background:transparent;font-size:11px">üìñ ${matched.source} ‚Üó</a>
              <a href="https://www.google.com/search?q=${googleQ}" target="_blank" class="source-link" style="background:transparent;font-size:11px">üîç Search Treatment ‚Üó</a>
            </div>
          </div>
        </div>`;
    } else {
      adrCounts.safe++;
      updateADRCounts();
      const googleQ = encodeURIComponent(`${drug1} ${drug2} drug interaction`);
      resultEl.innerHTML = `
        <div class="adr-alert adr-info">
          <div class="adr-icon">‚úì</div>
          <div>
            <div style="font-weight:800;font-size:14px;margin-bottom:6px">No Major Interaction Found in Database</div>
            <p style="font-size:13px;margin-bottom:8px">${drug1.toUpperCase()} + ${drug2.toUpperCase()} ‚Äî No critical interaction identified in MediSync's local database. Always verify with clinical pharmacist.</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a href="https://www.drugs.com/interactions-check.php?drug_list=${encodeURIComponent(drug1+','+drug2)}" target="_blank" class="source-link" style="background:transparent;font-size:11px">üîç Check Drugs.com ‚Üó</a>
              <a href="https://bnf.nice.org.uk" target="_blank" class="source-link" style="background:transparent;font-size:11px">üìñ Check BNF/NICE ‚Üó</a>
              <a href="https://www.google.com/search?q=${googleQ}" target="_blank" class="source-link" style="background:transparent;font-size:11px">üîç Google Search ‚Üó</a>
            </div>
          </div>
        </div>`;
    }
  }, 800);
}

function updateADRCounts() {
  setEl('adr-count-critical', adrCounts.critical);
  setEl('adr-count-moderate', adrCounts.moderate);
  setEl('adr-count-minor', adrCounts.minor);
  setEl('adr-count-safe', adrCounts.safe);
}

function reportADR() {
  const drug = document.getElementById('adr-report-drug').value.trim();
  const pid = document.getElementById('adr-report-pid').value.trim();
  const reaction = document.getElementById('adr-report-reaction').value.trim();
  const severity = document.getElementById('adr-report-severity').value;
  if (!drug || !reaction) { alert('Please fill in drug name and reaction.'); return; }
  const entry = { time: new Date().toLocaleString(), drug, pid: pid || 'Unknown', reaction, severity };
  adrLog.unshift(entry);
  renderADRLog();
  document.getElementById('adr-report-drug').value = '';
  document.getElementById('adr-report-reaction').value = '';
}

function renderADRLog() {
  const tbody = document.getElementById('adr-log-body');
  if (!adrLog.length) { tbody.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">No ADR events logged yet.</td></tr>'; return; }
  tbody.innerHTML = adrLog.map(e => `
    <tr>
      <td style="font-size:11px;color:var(--text4)">${e.time}</td>
      <td style="font-weight:600">${e.drug}</td>
      <td>${e.pid}</td>
      <td>${e.reaction}</td>
      <td><span class="tag ${e.severity === 'severe' ? 'tg-r' : e.severity === 'moderate' ? 'tg-y' : 'tg-b'}">${e.severity}</span></td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  const data = await apiFetch('/api/dashboard');
  const stats = data?.stats || { prescriptions_processed: 2, chatbot_sessions: 2, risk_predictions: 0, rag_queries: 0, contacts_received: 0 };
  const rd = data?.risk_distribution || { Low: 0, Medium: 0, High: 0 };

  document.getElementById('dash-stats').innerHTML = [
    ['üíä', stats.prescriptions_processed, 'Prescriptions'],
    ['üß†', stats.chatbot_sessions, 'Chat Sessions'],
    ['‚öïÔ∏è', stats.risk_predictions, 'Risk Checks'],
    ['üîç', stats.rag_queries, 'RAG Queries'],
    ['üìã', scanDB.length, 'Scans Stored'],
    ['‚ö†Ô∏è', adrLog.length, 'ADR Events']
  ].map(([icon, val, label]) => `
    <div class="stat-card">
      <div style="font-size:22px;margin-bottom:8px">${icon}</div>
      <div class="stat-val">${val}</div>
      <div class="stat-lbl">${label}</div>
    </div>`).join('');

  const mu = data?.module_usage || { 'Prescription AI': stats.prescriptions_processed, 'WellnessBot': stats.chatbot_sessions, 'Risk AI': stats.risk_predictions, 'RAG Agent': stats.rag_queries };
  const maxV = Math.max(...Object.values(mu), 1);
  const barColors = ['#2563eb','#7c3aed','#059669','#d97706','#0891b2','#dc2626'];
  document.getElementById('dash-bars').innerHTML = Object.entries(mu).map(([k, v], i) => {
    const h = Math.max(Math.round((v / maxV) * 110), 8);
    return `<div style="display:flex;flex-direction:column;align-items:center;gap:5px;flex:1">
      <div style="font-size:12px;font-weight:700;color:var(--text2)">${v}</div>
      <div style="width:100%;height:${h}px;background:${barColors[i % barColors.length]};border-radius:6px 6px 0 0;opacity:.85"></div>
      <div style="font-size:10px;color:var(--text3);text-align:center;line-height:1.3">${k}</div></div>`;
  }).join('');

  const total = Object.values(rd).reduce((a, b) => a + b, 0) || 1;
  document.getElementById('dash-risk').innerHTML = [['Low','#059669','tg-g'],['Medium','#d97706','tg-y'],['High','#dc2626','tg-r']].map(([k, col, cls]) => {
    const pct = Math.round((rd[k]||0)/total*100);
    return `<div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:13px;color:var(--text2)">${k} Risk</span><span class="tag ${cls}">${pct}%</span></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${col}"></div></div></div>`;
  }).join('');

  const rxData = await apiFetch('/api/prescriptions');
  const prescriptions = rxData?.prescriptions || [
    { patient: 'John Doe', fhir: { medicationCodeableConcept: { coding: [{ display: 'Metformin 500mg' }] } } },
    { patient: 'Priya Patel', fhir: { medicationCodeableConcept: { coding: [{ display: 'Lisinopril 10mg' }] } } }
  ];
  document.getElementById('dash-rx-rows').innerHTML = prescriptions.slice(0,4).map(p =>
    `<tr><td style="font-weight:600">${p.patient || 'N/A'}</td><td>${p.fhir?.medicationCodeableConcept?.coding?.[0]?.display || 'N/A'}</td><td><span class="tag tg-g">Active</span></td></tr>`
  ).join('') || '<tr><td colspan="3" class="muted">No prescriptions yet</td></tr>';

  document.getElementById('dash-sess-rows').innerHTML = (data?.recent_sessions || [
    { id: 'MH-001', user: 'User #001', topic: 'Anxiety & work stress', duration_min: 8 },
    { id: 'MH-002', user: 'User #002', topic: 'Sleep difficulties', duration_min: 12 }
  ]).map(s =>
    `<tr><td>${s.id||'N/A'}</td><td>${s.topic||s.message_preview||'N/A'}</td><td>${s.duration_min ? s.duration_min+' min' : 'Active'}</td></tr>`
  ).join('') || '<tr><td colspan="3" class="muted">No sessions</td></tr>';
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadReportSummary() {
  const data = await apiFetch('/api/report/summary');
  const el = document.getElementById('rpt-summary');
  el.innerHTML = `
    <div class="g2" style="gap:10px">
      <div style="background:var(--surface3);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--primary)">${data?.total_prescriptions ?? 2}</div><div style="font-size:11px;color:var(--text3)">Prescriptions</div></div>
      <div style="background:var(--surface3);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--accent)">${data?.total_sessions ?? 2}</div><div style="font-size:11px;color:var(--text3)">Chat Sessions</div></div>
      <div style="background:var(--surface3);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--warn)">${data?.total_risk_predictions ?? 0}</div><div style="font-size:11px;color:var(--text3)">Risk Checks</div></div>
      <div style="background:var(--surface3);border-radius:10px;padding:14px;text-align:center"><div style="font-size:22px;font-weight:800;color:var(--danger)">${adrLog.length}</div><div style="font-size:11px;color:var(--text3)">ADR Events</div></div>
    </div>`;
}

async function generateReport() {
  const btn = document.getElementById('rpt-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Generating‚Ä¶';
  const incRx = document.getElementById('rpt-rx').checked;
  const incRisk = document.getElementById('rpt-risk').checked;
  const incChat = document.getElementById('rpt-chat').checked;
  const format = document.getElementById('rpt-format').value;
  const data = await apiFetch('/api/report/generate', { method: 'POST', body: JSON.stringify({ include_prescriptions: incRx, include_risk: incRisk, include_chatbot: incChat }) });
  btn.disabled = false; btn.innerHTML = 'üìÑ Generate Report';
  const report = buildReport(data, { incRx, incRisk, incChat });
  if (format === 'html') downloadFile(buildHTMLReport(report), `MediSync_Report_${new Date().toISOString().split('T')[0]}.html`, 'text/html');
  else if (format === 'json') downloadFile(JSON.stringify(data || report, null, 2), `MediSync_Report_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
  else if (format === 'csv') downloadFile(buildCSV(data), `MediSync_Report_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
  else downloadFile(buildTextReport(report), `MediSync_Report_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
  document.getElementById('rpt-ok').classList.add('show');
  setTimeout(() => document.getElementById('rpt-ok').classList.remove('show'), 3000);
}

function buildReport(data, opts) {
  return { report_id: data?.report_id || 'RPT-LOCAL', generated: new Date().toISOString(), prescriptions: data?.prescriptions || [], risk: data?.risk_predictions || [], sessions: data?.chatbot_sessions || [], adr: adrLog, scans: scanDB };
}

function buildTextReport(r) {
  let txt = `MEDISYNC AI ‚Äî PLATFORM REPORT\nReport ID: ${r.report_id}\nGenerated: ${new Date(r.generated).toLocaleString()}\n${'='.repeat(52)}\n`;
  if (r.prescriptions.length) { txt += '\nPRESCRIPTIONS\n' + '-'.repeat(30) + '\n'; r.prescriptions.forEach(p => txt += `${p.id} | ${p.patient} | ${p.medication}\n`); }
  if (r.adr.length) { txt += '\nADR EVENTS\n' + '-'.repeat(30) + '\n'; r.adr.forEach(a => txt += `${a.time} | ${a.drug} | ${a.patient || a.pid} | ${a.reaction} | ${a.severity}\n`); }
  if (r.scans.length) { txt += '\nSCAN RECORDS\n' + '-'.repeat(30) + '\n'; r.scans.forEach(s => txt += `${s.id} | ${s.patient} | ${s.type.toUpperCase()} | ${s.region}\n`); }
  txt += `\n${'='.repeat(52)}\nMediSync AI Platform v3.0\n`;
  return txt;
}

function buildHTMLReport(r) {
  return `<!DOCTYPE html><html><head><title>MediSync Report</title><style>body{font-family:Arial;padding:32px;max-width:800px;margin:0 auto}.hdr{color:#2563eb;border-bottom:2px solid #2563eb;padding-bottom:12px;margin-bottom:24px}table{width:100%;border-collapse:collapse;margin-bottom:24px}th{background:#f1f5f9;padding:8px 12px;text-align:left;font-size:12px;text-transform:uppercase}td{padding:8px 12px;border-bottom:1px solid #e2e8f0;font-size:13px}.section-title{font-size:16px;font-weight:bold;margin:24px 0 10px;color:#334155}</style></head><body><div class="hdr"><h1 style="margin:0">‚¨° MediSync AI ‚Äî Platform Report</h1><p style="color:#64748b;margin:4px 0 0">Report ID: ${r.report_id} ‚Ä¢ Generated: ${new Date(r.generated).toLocaleString()}</p></div>${r.prescriptions.length ? `<div class="section-title">üíä Prescriptions</div><table><thead><tr><th>ID</th><th>Patient</th><th>Medication</th></tr></thead><tbody>${r.prescriptions.map(p=>`<tr><td>${p.id}</td><td>${p.patient}</td><td>${p.medication}</td></tr>`).join('')}</tbody></table>` : ''}${r.adr.length ? `<div class="section-title">‚ö†Ô∏è ADR Events</div><table><thead><tr><th>Time</th><th>Drug</th><th>Reaction</th><th>Severity</th></tr></thead><tbody>${r.adr.map(a=>`<tr><td>${a.time}</td><td>${a.drug}</td><td>${a.reaction}</td><td>${a.severity}</td></tr>`).join('')}</tbody></table>` : ''}</body></html>`;
}

function buildCSV(data) {
  let csv = 'Report ID,Generated\n' + (data?.report_id || 'LOCAL') + ',' + new Date().toISOString() + '\n\n';
  if (data?.prescriptions?.length) { csv += 'PRESCRIPTIONS\nID,Patient,Medication,Status\n'; data.prescriptions.forEach(p => csv += `${p.id},${p.patient},${p.medication},${p.status}\n`); }
  return csv;
}

function previewReport() {
  const r = buildReport({}, {});
  const panel = document.getElementById('rpt-preview-panel');
  document.getElementById('rpt-preview-content').textContent = buildTextReport(r);
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth' });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Add some demo scans
scanDB.push({ id:'SCN-001', patient:'John Doe', pid:'PT-00123', type:'mri', region:'Brain / Head', notes:'Routine annual MRI ‚Äî no acute abnormalities', physician:'Dr. Patel', filename:'brain_mri.jpg', date:new Date().toISOString(), preview:null });
scanDB.push({ id:'SCN-002', patient:'Priya Sharma', pid:'PT-00456', type:'xray', region:'Chest / Thorax', notes:'Mild cardiomegaly. No pleural effusion.', physician:'Dr. Kumar', filename:'chest_xray.png', date:new Date().toISOString(), preview:null });
scanDB.push({ id:'SCN-003', patient:'Ravi Mehta', pid:'PT-00789', type:'ct', region:'Abdomen', notes:'CT abdomen with contrast ‚Äî no mass lesion', physician:'Dr. Singh', filename:'abdomen_ct.dcm', date:new Date().toISOString(), preview:null });

// Initialize and load prescriptions when Rx page is viewed
setTimeout(() => {
  if (currentUser && currentUser.name) {
    console.log('Auto-loading prescriptions for:', currentUser.name);
    loadPrescriptions().catch(e => console.error('Prescription load error:', e));
  }
}, 500);
</script>
</body>
</html>